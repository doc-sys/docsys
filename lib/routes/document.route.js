"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _express = _interopRequireDefault(require("express"));

var _expressValidator = require("express-validator");

var _stream = require("stream");

var _authenticate = _interopRequireWildcard(require("../lib/helpers/authenticate"));

var _document = require("../controller/document.controller");

var _documentCreateNew = _interopRequireDefault(require("../lib/requestSchemas/document.createNew.json"));

var _documentCheckout = _interopRequireDefault(require("../lib/requestSchemas/document.checkout.json"));

var _documentShare = _interopRequireDefault(require("../lib/requestSchemas/document.share.json"));

var _documentFileid = _interopRequireDefault(require("../lib/requestSchemas/document.fileid.json"));

var _validator = require("../lib/helpers/validator");

var multer = require('multer');

var router = _express["default"].Router();

var uploadFileHandler = multer({
  storage: multer.memoryStorage()
});
router.route('/')
/**
 * @api {get} /document/ All documents
 * @apiName documentsGetAll
 * @apiGroup Document
 * @apiDescription Gets all documents on the instance. Can only be accessed by an admin.
 * @apiSuccess {Object[]} document All documents
 * @apiError (401) NotAuthorized Only admins are allow to access this ressource
 * @apiError (500) InternalServerError Something went wron processing your request
 */
.get([_authenticate["default"], _authenticate.requireAdmin, _document.getAllFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
})
/**
* @api {post} /document/ New document
* @apiName documentCreate
* @apiGroup Document
* @apiDescription Creates and uploads a new documents with its body.
* @apiParam {Buffer[]} files Page(s) for the document
* @apiParam {String} title Documents subject or title
* @apiParam {Date} dated Date the original document was recieved
* @apiParam {String} comment Comment to append to log
* @apiSuccess {Object} document The created document
* @apiError (415) {String} FileTypeError Filetype is not supported. So far only PDFs and picture types are supported
* @apiError (500) {String} InternalError Something went wrong
*/
.post([_authenticate["default"], uploadFileHandler.single('documents'), (0, _expressValidator.checkSchema)(_documentCreateNew["default"]), _validator.checkSchemaValidation, _document.createNewFile, _document.uploadFiles], function (req, res) {
  res.status(200).json({
    document: res.locals.file
  });
});
router.route('/own')
/**
 * @api {get} /document/own Own documents
 * @apiName documentGetOwn
 * @apiGroup Document
 * @apiDescription Returns the users documents
 * @apiSuccess {Array} docs User documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getOwnFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
});
router.route('/shared')
/**
 * @api {get} /document/shared Shared documents
 * @apiName documentGetShared
 * @apiGroup Document
 * @apiDescription Returns the documents shared with the user
 * @apiSuccess {Array} sharedDocs Shared documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getSharedFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
});
router.route('/checkout/:fileid')
/**
 * @api {get} /document/checkout/:fileid Document checkout
 * @apiName documentCheckout
 * @apiGroup Document
 * @apiDescription Checks out document and sends files as ZIP archive
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess (200) {Stream} ZIP file stream
 * @apiError (401) PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile,,
/* lockFile */
_document.downloadFile], /*#__PURE__*/function () {
  var _ref = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee(req, res) {
    var stream;
    return _regenerator["default"].wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            res.writeHead(200, {
              'Content-Type': res.locals.file.mimetype,
              'Content-disposition': "attachment; filename=".concat(res.locals.file.title, ".").concat(res.locals.file.extension)
            });
            stream = new _stream.Readable();

            stream._read = function () {};

            stream.push(res.locals.fileBuffer);
            stream.push(null);
            stream.pipe(res);

          case 6:
          case "end":
            return _context.stop();
        }
      }
    }, _callee);
  }));

  return function (_x, _x2) {
    return _ref.apply(this, arguments);
  };
}())
/**
 * @api {post} /document/checkout/:fileid
 * @apiName documentCheckin
 * @apiGroup Document
 * @apiDescription Accepts an upload for a locked file and unlocks said file
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiSuccess (200) {Object} The uploaded document
 * @apiError (401) PermissionError Not allowed to POST this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile, uploadFileHandler.array('documents'), _document.uploadFiles, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
})
/**
* @api {unlock} /document/checkout/:fileid
* @apiName documentAdminUnlock
* @apiGroup Document
* @apiDescription Unlocks a locked document without actually submitting a new document file. Requires user to be an admin
* @apiParam {String} fileid The fileid as part of the POST URL
* @apiSuccess (200) {Object} The unlocked document
* @apiError (401) PermissionError Not allowed to UNLOCK this file
* @apiError (500) {String} InternalError Something went wrong
*/
.unlock([_authenticate["default"], _authenticate.requireAdmin, (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
router.route('/share/:fileid')
/**
 * @api {post} /document/share/:fileid
 * @apiName documentShareFile
 * @apiGroup Document
 * @apiDescription Shares file with a new user
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiParam {String} whoToShare Username to share the file with. Provided in body or query.
 * @apiSuccess (200) {Object} The updated document
 * @apiError (401) PermissionError Not allowed to edit this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentShare["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.shareFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
router.route('/:fileid')
/**
 * @api {get} /document/:fileid Get single document
 * @apiName documentGetSingle
 * @apiGroup Document
 * @apiDescription Returns the single requested document
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess {Object} document The requested object
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
})
/**
* @api {delete} /document/:fileid Deletes document
* @apiName documentDeleteSingle
* @apiGroup Document
* @apiDescription Deletes the requested document
* @apiParam {String} fileid The fileid as part of the GET URL
* @apiSuccess {Object} document The deleted object
* @apiError (401) {String} PermissionError Not allowed to DELETE this file
* @apiError (500) {String} InternalError Something went wrong
*/
["delete"]([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.deleteSingleFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvZG9jdW1lbnQucm91dGUudHMiXSwibmFtZXMiOlsibXVsdGVyIiwicmVxdWlyZSIsInJvdXRlciIsImV4cHJlc3MiLCJSb3V0ZXIiLCJ1cGxvYWRGaWxlSGFuZGxlciIsInN0b3JhZ2UiLCJtZW1vcnlTdG9yYWdlIiwicm91dGUiLCJnZXQiLCJhdXRoZW50aWNhdGUiLCJyZXF1aXJlQWRtaW4iLCJnZXRBbGxGaWxlcyIsInJlcSIsInJlcyIsInN0YXR1cyIsImpzb24iLCJkb2NzIiwibG9jYWxzIiwiZmlsZXMiLCJwb3N0Iiwic2luZ2xlIiwiY3JlYXRlTmV3IiwiY2hlY2tTY2hlbWFWYWxpZGF0aW9uIiwiY3JlYXRlTmV3RmlsZSIsInVwbG9hZEZpbGVzIiwiZG9jdW1lbnQiLCJmaWxlIiwiZ2V0T3duRmlsZXMiLCJnZXRTaGFyZWRGaWxlcyIsImNoZWNrb3V0IiwiZ2V0U2luZ2xlRmlsZSIsImNoZWNrUGVybWlzc2lvblRvRmlsZSIsImRvd25sb2FkRmlsZSIsIndyaXRlSGVhZCIsIm1pbWV0eXBlIiwidGl0bGUiLCJleHRlbnNpb24iLCJzdHJlYW0iLCJSZWFkYWJsZSIsIl9yZWFkIiwicHVzaCIsImZpbGVCdWZmZXIiLCJwaXBlIiwiYXJyYXkiLCJ1bmxvY2tGaWxlIiwiZG9jIiwidW5sb2NrIiwic2hhcmUiLCJzaGFyZUZpbGUiLCJmaWxlaWQiLCJkZWxldGVTaW5nbGVGaWxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQVZBLElBQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBWUEsSUFBSUMsTUFBTSxHQUFHQyxvQkFBUUMsTUFBUixFQUFiOztBQUNBLElBQUlDLGlCQUFpQixHQUFHTCxNQUFNLENBQUM7QUFDM0JNLEVBQUFBLE9BQU8sRUFBRU4sTUFBTSxDQUFDTyxhQUFQO0FBRGtCLENBQUQsQ0FBOUI7QUFJQUwsTUFBTSxDQUFDTSxLQUFQLENBQWEsR0FBYjtBQUNJOzs7Ozs7Ozs7QUFESixDQVVLQyxHQVZMLENBVVMsQ0FBQ0Msd0JBQUQsRUFBZUMsMEJBQWYsRUFBNkJDLHFCQUE3QixDQVZULEVBVW9ELFVBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQzFEQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFQyxJQUFBQSxJQUFJLEVBQUVILEdBQUcsQ0FBQ0ksTUFBSixDQUFXQztBQUFuQixHQUFyQjtBQUNILENBWkw7QUFhSTs7Ozs7Ozs7Ozs7OztBQWJKLENBMEJLQyxJQTFCTCxDQTBCVSxDQUFDVix3QkFBRCxFQUFlTCxpQkFBaUIsQ0FBQ2dCLE1BQWxCLENBQXlCLFdBQXpCLENBQWYsRUFBc0QsbUNBQVlDLDZCQUFaLENBQXRELEVBQXFGQyxnQ0FBckYsRUFBNEdDLHVCQUE1RyxFQUEySEMscUJBQTNILENBMUJWLEVBMEJtSixVQUFDWixHQUFELEVBQU1DLEdBQU4sRUFBYztBQUN6SkEsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRVUsSUFBQUEsUUFBUSxFQUFFWixHQUFHLENBQUNJLE1BQUosQ0FBV1M7QUFBdkIsR0FBckI7QUFDSCxDQTVCTDtBQThCQXpCLE1BQU0sQ0FBQ00sS0FBUCxDQUFhLE1BQWI7QUFDSTs7Ozs7Ozs7O0FBREosQ0FVS0MsR0FWTCxDQVVTLENBQUNDLHdCQUFELEVBQWVrQixxQkFBZixDQVZULEVBVXNDLFVBQUNmLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQzVDQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFQyxJQUFBQSxJQUFJLEVBQUVILEdBQUcsQ0FBQ0ksTUFBSixDQUFXQztBQUFuQixHQUFyQjtBQUNILENBWkw7QUFjQWpCLE1BQU0sQ0FBQ00sS0FBUCxDQUFhLFNBQWI7QUFDSTs7Ozs7Ozs7O0FBREosQ0FVS0MsR0FWTCxDQVVTLENBQUNDLHdCQUFELEVBQWVtQix3QkFBZixDQVZULEVBVXlDLFVBQUNoQixHQUFELEVBQU1DLEdBQU4sRUFBYztBQUMvQ0EsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRUMsSUFBQUEsSUFBSSxFQUFFSCxHQUFHLENBQUNJLE1BQUosQ0FBV0M7QUFBbkIsR0FBckI7QUFDSCxDQVpMO0FBY0FqQixNQUFNLENBQUNNLEtBQVAsQ0FBYSxtQkFBYjtBQUNJOzs7Ozs7Ozs7O0FBREosQ0FXS0MsR0FYTCxDQVdTLENBQUNDLHdCQUFELEVBQWUsbUNBQVlvQiw0QkFBWixDQUFmLEVBQXNDUCxnQ0FBdEMsRUFBNkRRLHVCQUE3RCxFQUE0RUMsK0JBQTVFO0FBQW1HO0FBQWdCQyxzQkFBbkgsQ0FYVDtBQUFBLDJGQVcySSxpQkFBT3BCLEdBQVAsRUFBWUMsR0FBWjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDbklBLFlBQUFBLEdBQUcsQ0FBQ29CLFNBQUosQ0FBYyxHQUFkLEVBQW1CO0FBQ2YsOEJBQWdCcEIsR0FBRyxDQUFDSSxNQUFKLENBQVdTLElBQVgsQ0FBZ0JRLFFBRGpCO0FBRWYsb0VBQStDckIsR0FBRyxDQUFDSSxNQUFKLENBQVdTLElBQVgsQ0FBZ0JTLEtBQS9ELGNBQXdFdEIsR0FBRyxDQUFDSSxNQUFKLENBQVdTLElBQVgsQ0FBZ0JVLFNBQXhGO0FBRmUsYUFBbkI7QUFLTUMsWUFBQUEsTUFONkgsR0FNcEgsSUFBSUMsZ0JBQUosRUFOb0g7O0FBT25JRCxZQUFBQSxNQUFNLENBQUNFLEtBQVAsR0FBZSxZQUFNLENBQUcsQ0FBeEI7O0FBQ0FGLFlBQUFBLE1BQU0sQ0FBQ0csSUFBUCxDQUFZM0IsR0FBRyxDQUFDSSxNQUFKLENBQVd3QixVQUF2QjtBQUNBSixZQUFBQSxNQUFNLENBQUNHLElBQVAsQ0FBWSxJQUFaO0FBRUFILFlBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZN0IsR0FBWjs7QUFYbUk7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsR0FYM0k7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUF3Qkk7Ozs7Ozs7Ozs7QUF4QkosQ0FrQ0tNLElBbENMLENBa0NVLENBQUNWLHdCQUFELEVBQWUsbUNBQVlvQiw0QkFBWixDQUFmLEVBQTZDUCxnQ0FBN0MsRUFBb0VRLHVCQUFwRSxFQUFtRkMsK0JBQW5GLEVBQTBHM0IsaUJBQWlCLENBQUN1QyxLQUFsQixDQUF3QixXQUF4QixDQUExRyxFQUFnSm5CLHFCQUFoSixFQUE2Sm9CLG9CQUE3SixDQWxDVixFQWtDb0wsVUFBQ2hDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQzFMQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFOEIsSUFBQUEsR0FBRyxFQUFFaEMsR0FBRyxDQUFDSSxNQUFKLENBQVdTO0FBQWxCLEdBQXJCO0FBQ0gsQ0FwQ0w7QUFxQ0k7Ozs7Ozs7Ozs7QUFyQ0osQ0ErQ0tvQixNQS9DTCxDQStDWSxDQUFDckMsd0JBQUQsRUFBZUMsMEJBQWYsRUFBNkIsbUNBQVltQiw0QkFBWixDQUE3QixFQUFvRFAsZ0NBQXBELEVBQTJFUSx1QkFBM0UsRUFBMEZjLG9CQUExRixDQS9DWixFQStDbUgsVUFBQ2hDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ3pIQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFOEIsSUFBQUEsR0FBRyxFQUFFaEMsR0FBRyxDQUFDSSxNQUFKLENBQVdTO0FBQWxCLEdBQXJCO0FBQ0gsQ0FqREw7QUFtREF6QixNQUFNLENBQUNNLEtBQVAsQ0FBYSxnQkFBYjtBQUNJOzs7Ozs7Ozs7OztBQURKLENBWUtZLElBWkwsQ0FZVSxDQUFDVix3QkFBRCxFQUFlLG1DQUFZc0MseUJBQVosQ0FBZixFQUFtQ3pCLGdDQUFuQyxFQUEwRFEsdUJBQTFELEVBQXlFa0IsbUJBQXpFLENBWlYsRUFZK0YsVUFBQ3BDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ3JHQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFOEIsSUFBQUEsR0FBRyxFQUFFaEMsR0FBRyxDQUFDSSxNQUFKLENBQVdTO0FBQWxCLEdBQXJCO0FBQ0gsQ0FkTDtBQWdCQXpCLE1BQU0sQ0FBQ00sS0FBUCxDQUFhLFVBQWI7QUFDSTs7Ozs7Ozs7OztBQURKLENBV0tDLEdBWEwsQ0FXUyxDQUFDQyx3QkFBRCxFQUFlLG1DQUFZd0MsMEJBQVosQ0FBZixFQUFvQzNCLGdDQUFwQyxFQUEyRFEsdUJBQTNELEVBQTBFQywrQkFBMUUsQ0FYVCxFQVcyRyxVQUFDbkIsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDakhBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUU4QixJQUFBQSxHQUFHLEVBQUVoQyxHQUFHLENBQUNJLE1BQUosQ0FBV1M7QUFBbEIsR0FBckI7QUFDSCxDQWJMO0FBY0k7Ozs7Ozs7Ozs7QUFkSixXQXdCWSxDQUFDakIsd0JBQUQsRUFBZSxtQ0FBWXdDLDBCQUFaLENBQWYsRUFBb0MzQixnQ0FBcEMsRUFBMkQ0QiwwQkFBM0QsQ0F4QlosRUF3QjBGLFVBQUN0QyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNoR0EsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRThCLElBQUFBLEdBQUcsRUFBRWhDLEdBQUcsQ0FBQ0ksTUFBSixDQUFXUztBQUFsQixHQUFyQjtBQUNILENBMUJMO0FBNEJBeUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbkQsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcywgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSBcImV4cHJlc3NcIlxyXG5pbXBvcnQgeyBjaGVja1NjaGVtYSB9IGZyb20gJ2V4cHJlc3MtdmFsaWRhdG9yJ1xyXG5jb25zdCBtdWx0ZXIgPSByZXF1aXJlKCdtdWx0ZXInKVxyXG5pbXBvcnQgeyBSZWFkYWJsZSB9IGZyb20gXCJzdHJlYW1cIlxyXG5cclxuaW1wb3J0IGF1dGhlbnRpY2F0ZSwgeyByZXF1aXJlQWRtaW4gfSBmcm9tICcuLi9saWIvaGVscGVycy9hdXRoZW50aWNhdGUnXHJcbmltcG9ydCB7IGdldEFsbEZpbGVzLCBjcmVhdGVOZXdGaWxlLCB1cGxvYWRGaWxlcywgZ2V0T3duRmlsZXMsIGdldFNoYXJlZEZpbGVzLCBjaGVja1Blcm1pc3Npb25Ub0ZpbGUsIGxvY2tGaWxlLCBnZXRTaW5nbGVGaWxlLCBkb3dubG9hZEZpbGUsIHVubG9ja0ZpbGUsIHNoYXJlRmlsZSwgY2hlY2tGaWxlT3duZXJzaGlwLCBkZWxldGVTaW5nbGVGaWxlIH0gZnJvbSAnLi4vY29udHJvbGxlci9kb2N1bWVudC5jb250cm9sbGVyJztcclxuXHJcbmltcG9ydCBjcmVhdGVOZXcgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LmNyZWF0ZU5ldy5qc29uJ1xyXG5pbXBvcnQgY2hlY2tvdXQgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LmNoZWNrb3V0Lmpzb24nXHJcbmltcG9ydCBzaGFyZSBmcm9tICcuLi9saWIvcmVxdWVzdFNjaGVtYXMvZG9jdW1lbnQuc2hhcmUuanNvbidcclxuaW1wb3J0IGZpbGVpZCBmcm9tICcuLi9saWIvcmVxdWVzdFNjaGVtYXMvZG9jdW1lbnQuZmlsZWlkLmpzb24nXHJcbmltcG9ydCB7IGNoZWNrU2NoZW1hVmFsaWRhdGlvbiB9IGZyb20gJy4uL2xpYi9oZWxwZXJzL3ZhbGlkYXRvcic7XHJcblxyXG5sZXQgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKVxyXG5sZXQgdXBsb2FkRmlsZUhhbmRsZXIgPSBtdWx0ZXIoe1xyXG4gICAgc3RvcmFnZTogbXVsdGVyLm1lbW9yeVN0b3JhZ2UoKVxyXG59KVxyXG5cclxucm91dGVyLnJvdXRlKCcvJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvIEFsbCBkb2N1bWVudHNcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50c0dldEFsbFxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gR2V0cyBhbGwgZG9jdW1lbnRzIG9uIHRoZSBpbnN0YW5jZS4gQ2FuIG9ubHkgYmUgYWNjZXNzZWQgYnkgYW4gYWRtaW4uXHJcbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0W119IGRvY3VtZW50IEFsbCBkb2N1bWVudHNcclxuICAgICAqIEBhcGlFcnJvciAoNDAxKSBOb3RBdXRob3JpemVkIE9ubHkgYWRtaW5zIGFyZSBhbGxvdyB0byBhY2Nlc3MgdGhpcyByZXNzb3VyY2VcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBJbnRlcm5hbFNlcnZlckVycm9yIFNvbWV0aGluZyB3ZW50IHdyb24gcHJvY2Vzc2luZyB5b3VyIHJlcXVlc3RcclxuICAgICAqL1xyXG4gICAgLmdldChbYXV0aGVudGljYXRlLCByZXF1aXJlQWRtaW4sIGdldEFsbEZpbGVzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2NzOiByZXMubG9jYWxzLmZpbGVzIH0pXHJcbiAgICB9KVxyXG4gICAgLyoqXHJcbiAgICAqIEBhcGkge3Bvc3R9IC9kb2N1bWVudC8gTmV3IGRvY3VtZW50XHJcbiAgICAqIEBhcGlOYW1lIGRvY3VtZW50Q3JlYXRlXHJcbiAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgKiBAYXBpRGVzY3JpcHRpb24gQ3JlYXRlcyBhbmQgdXBsb2FkcyBhIG5ldyBkb2N1bWVudHMgd2l0aCBpdHMgYm9keS5cclxuICAgICogQGFwaVBhcmFtIHtCdWZmZXJbXX0gZmlsZXMgUGFnZShzKSBmb3IgdGhlIGRvY3VtZW50XHJcbiAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSB0aXRsZSBEb2N1bWVudHMgc3ViamVjdCBvciB0aXRsZVxyXG4gICAgKiBAYXBpUGFyYW0ge0RhdGV9IGRhdGVkIERhdGUgdGhlIG9yaWdpbmFsIGRvY3VtZW50IHdhcyByZWNpZXZlZFxyXG4gICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gY29tbWVudCBDb21tZW50IHRvIGFwcGVuZCB0byBsb2dcclxuICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gZG9jdW1lbnQgVGhlIGNyZWF0ZWQgZG9jdW1lbnRcclxuICAgICogQGFwaUVycm9yICg0MTUpIHtTdHJpbmd9IEZpbGVUeXBlRXJyb3IgRmlsZXR5cGUgaXMgbm90IHN1cHBvcnRlZC4gU28gZmFyIG9ubHkgUERGcyBhbmQgcGljdHVyZSB0eXBlcyBhcmUgc3VwcG9ydGVkXHJcbiAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAqL1xyXG4gICAgLnBvc3QoW2F1dGhlbnRpY2F0ZSwgdXBsb2FkRmlsZUhhbmRsZXIuc2luZ2xlKCdkb2N1bWVudHMnKSwgY2hlY2tTY2hlbWEoY3JlYXRlTmV3IGFzIGFueSksIGNoZWNrU2NoZW1hVmFsaWRhdGlvbiwgY3JlYXRlTmV3RmlsZSwgdXBsb2FkRmlsZXNdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvY3VtZW50OiByZXMubG9jYWxzLmZpbGUgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy9vd24nKVxyXG4gICAgLyoqXHJcbiAgICAgKiBAYXBpIHtnZXR9IC9kb2N1bWVudC9vd24gT3duIGRvY3VtZW50c1xyXG4gICAgICogQGFwaU5hbWUgZG9jdW1lbnRHZXRPd25cclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIFJldHVybnMgdGhlIHVzZXJzIGRvY3VtZW50c1xyXG4gICAgICogQGFwaVN1Y2Nlc3Mge0FycmF5fSBkb2NzIFVzZXIgZG9jdW1lbnRzIGJhc2ljIG1ldGFkYXRhXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgZ2V0T3duRmlsZXNdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvY3M6IHJlcy5sb2NhbHMuZmlsZXMgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy9zaGFyZWQnKVxyXG4gICAgLyoqXHJcbiAgICAgKiBAYXBpIHtnZXR9IC9kb2N1bWVudC9zaGFyZWQgU2hhcmVkIGRvY3VtZW50c1xyXG4gICAgICogQGFwaU5hbWUgZG9jdW1lbnRHZXRTaGFyZWRcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIFJldHVybnMgdGhlIGRvY3VtZW50cyBzaGFyZWQgd2l0aCB0aGUgdXNlclxyXG4gICAgICogQGFwaVN1Y2Nlc3Mge0FycmF5fSBzaGFyZWREb2NzIFNoYXJlZCBkb2N1bWVudHMgYmFzaWMgbWV0YWRhdGFcclxuICAgICAqIEBhcGlFcnJvciAoNDAxKSB7U3RyaW5nfSBQZXJtaXNzaW9uRXJyb3IgTm90IGFsbG93ZWQgdG8gR0VUIHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLmdldChbYXV0aGVudGljYXRlLCBnZXRTaGFyZWRGaWxlc10sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jczogcmVzLmxvY2Fscy5maWxlcyB9KVxyXG4gICAgfSlcclxuXHJcbnJvdXRlci5yb3V0ZSgnL2NoZWNrb3V0LzpmaWxlaWQnKVxyXG4gICAgLyoqXHJcbiAgICAgKiBAYXBpIHtnZXR9IC9kb2N1bWVudC9jaGVja291dC86ZmlsZWlkIERvY3VtZW50IGNoZWNrb3V0XHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudENoZWNrb3V0XHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBDaGVja3Mgb3V0IGRvY3VtZW50IGFuZCBzZW5kcyBmaWxlcyBhcyBaSVAgYXJjaGl2ZVxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIEdFVCBVUkxcclxuICAgICAqIEBhcGlTdWNjZXNzICgyMDApIHtTdHJlYW19IFpJUCBmaWxlIHN0cmVhbVxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBHRVQgdGhpcyBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAuZ2V0KFthdXRoZW50aWNhdGUsIGNoZWNrU2NoZW1hKGNoZWNrb3V0KSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBnZXRTaW5nbGVGaWxlLCBjaGVja1Blcm1pc3Npb25Ub0ZpbGUsIC8qIGxvY2tGaWxlICovLCBkb3dubG9hZEZpbGVdLCBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMud3JpdGVIZWFkKDIwMCwge1xyXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogcmVzLmxvY2Fscy5maWxlLm1pbWV0eXBlLFxyXG4gICAgICAgICAgICAnQ29udGVudC1kaXNwb3NpdGlvbic6IGBhdHRhY2htZW50OyBmaWxlbmFtZT0ke3Jlcy5sb2NhbHMuZmlsZS50aXRsZX0uJHtyZXMubG9jYWxzLmZpbGUuZXh0ZW5zaW9ufWAsXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgY29uc3Qgc3RyZWFtID0gbmV3IFJlYWRhYmxlKClcclxuICAgICAgICBzdHJlYW0uX3JlYWQgPSAoKSA9PiB7IH1cclxuICAgICAgICBzdHJlYW0ucHVzaChyZXMubG9jYWxzLmZpbGVCdWZmZXIpXHJcbiAgICAgICAgc3RyZWFtLnB1c2gobnVsbClcclxuXHJcbiAgICAgICAgc3RyZWFtLnBpcGUocmVzKVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7cG9zdH0gL2RvY3VtZW50L2NoZWNrb3V0LzpmaWxlaWRcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50Q2hlY2tpblxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gQWNjZXB0cyBhbiB1cGxvYWQgZm9yIGEgbG9ja2VkIGZpbGUgYW5kIHVubG9ja3Mgc2FpZCBmaWxlXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgUE9TVCBVUkxcclxuICAgICAqIEBhcGlTdWNjZXNzICgyMDApIHtPYmplY3R9IFRoZSB1cGxvYWRlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBQT1NUIHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLnBvc3QoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoY2hlY2tvdXQgYXMgYW55KSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBnZXRTaW5nbGVGaWxlLCBjaGVja1Blcm1pc3Npb25Ub0ZpbGUsIHVwbG9hZEZpbGVIYW5kbGVyLmFycmF5KCdkb2N1bWVudHMnKSwgdXBsb2FkRmlsZXMsIHVubG9ja0ZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG4gICAgLyoqXHJcbiAgICAqIEBhcGkge3VubG9ja30gL2RvY3VtZW50L2NoZWNrb3V0LzpmaWxlaWRcclxuICAgICogQGFwaU5hbWUgZG9jdW1lbnRBZG1pblVubG9ja1xyXG4gICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICogQGFwaURlc2NyaXB0aW9uIFVubG9ja3MgYSBsb2NrZWQgZG9jdW1lbnQgd2l0aG91dCBhY3R1YWxseSBzdWJtaXR0aW5nIGEgbmV3IGRvY3VtZW50IGZpbGUuIFJlcXVpcmVzIHVzZXIgdG8gYmUgYW4gYWRtaW5cclxuICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIFBPU1QgVVJMXHJcbiAgICAqIEBhcGlTdWNjZXNzICgyMDApIHtPYmplY3R9IFRoZSB1bmxvY2tlZCBkb2N1bWVudFxyXG4gICAgKiBAYXBpRXJyb3IgKDQwMSkgUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIFVOTE9DSyB0aGlzIGZpbGVcclxuICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICovXHJcbiAgICAudW5sb2NrKFthdXRoZW50aWNhdGUsIHJlcXVpcmVBZG1pbiwgY2hlY2tTY2hlbWEoY2hlY2tvdXQpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGdldFNpbmdsZUZpbGUsIHVubG9ja0ZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvc2hhcmUvOmZpbGVpZCcpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge3Bvc3R9IC9kb2N1bWVudC9zaGFyZS86ZmlsZWlkXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudFNoYXJlRmlsZVxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gU2hhcmVzIGZpbGUgd2l0aCBhIG5ldyB1c2VyXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgUE9TVCBVUkxcclxuICAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSB3aG9Ub1NoYXJlIFVzZXJuYW1lIHRvIHNoYXJlIHRoZSBmaWxlIHdpdGguIFByb3ZpZGVkIGluIGJvZHkgb3IgcXVlcnkuXHJcbiAgICAgKiBAYXBpU3VjY2VzcyAoMjAwKSB7T2JqZWN0fSBUaGUgdXBkYXRlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBlZGl0IHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLnBvc3QoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoc2hhcmUpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGdldFNpbmdsZUZpbGUsIHNoYXJlRmlsZV0sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jOiByZXMubG9jYWxzLmZpbGUgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy86ZmlsZWlkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvOmZpbGVpZCBHZXQgc2luZ2xlIGRvY3VtZW50XHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudEdldFNpbmdsZVxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gUmV0dXJucyB0aGUgc2luZ2xlIHJlcXVlc3RlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIEdFVCBVUkxcclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IGRvY3VtZW50IFRoZSByZXF1ZXN0ZWQgb2JqZWN0XHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoZmlsZWlkKSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBnZXRTaW5nbGVGaWxlLCBjaGVja1Blcm1pc3Npb25Ub0ZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG4gICAgLyoqXHJcbiAgICAqIEBhcGkge2RlbGV0ZX0gL2RvY3VtZW50LzpmaWxlaWQgRGVsZXRlcyBkb2N1bWVudFxyXG4gICAgKiBAYXBpTmFtZSBkb2N1bWVudERlbGV0ZVNpbmdsZVxyXG4gICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICogQGFwaURlc2NyaXB0aW9uIERlbGV0ZXMgdGhlIHJlcXVlc3RlZCBkb2N1bWVudFxyXG4gICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgR0VUIFVSTFxyXG4gICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSBkb2N1bWVudCBUaGUgZGVsZXRlZCBvYmplY3RcclxuICAgICogQGFwaUVycm9yICg0MDEpIHtTdHJpbmd9IFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBERUxFVEUgdGhpcyBmaWxlXHJcbiAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAqL1xyXG4gICAgLmRlbGV0ZShbYXV0aGVudGljYXRlLCBjaGVja1NjaGVtYShmaWxlaWQpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGRlbGV0ZVNpbmdsZUZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXIiXX0=