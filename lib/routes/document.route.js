"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _express = _interopRequireDefault(require("express"));

var _expressValidator = require("express-validator");

var _stream = require("stream");

var _authenticate = _interopRequireWildcard(require("../lib/helpers/authenticate"));

var _document = require("../controller/document.controller");

var _documentCreateNew = _interopRequireDefault(require("../lib/requestSchemas/document.createNew.json"));

var _documentCheckout = _interopRequireDefault(require("../lib/requestSchemas/document.checkout.json"));

var _documentShare = _interopRequireDefault(require("../lib/requestSchemas/document.share.json"));

var _documentFileid = _interopRequireDefault(require("../lib/requestSchemas/document.fileid.json"));

var _validator = require("../lib/helpers/validator");

var multer = require('multer');

var router = _express["default"].Router();

var uploadFileHandler = multer({
  storage: multer.memoryStorage()
});
router.route('/')
/**
 * @api {get} /document/ All documents
 * @apiName documentsGetAll
 * @apiGroup Document
 * @apiDescription Gets all documents on the instance. Can only be accessed by an admin.
 * @apiSuccess {Object[]} document All documents
 * @apiError (401) NotAuthorized Only admins are allow to access this ressource
 * @apiError (500) InternalServerError Something went wron processing your request
 */
.get([_authenticate["default"], _authenticate.requireAdmin, _document.getAllFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
})
/**
* @api {post} /document/ New document
* @apiName documentCreate
* @apiGroup Document
* @apiDescription Creates and uploads a new documents with its body.
* @apiParam {Buffer[]} files Page(s) for the document
* @apiParam {String} title Documents subject or title
* @apiParam {Date} dated Date the original document was recieved
* @apiParam {String} comment Comment to append to log
* @apiSuccess {Object} document The created document
* @apiError (415) {String} FileTypeError Filetype is not supported. So far only PDFs and picture types are supported
* @apiError (500) {String} InternalError Something went wrong
*/
.post([_authenticate["default"], uploadFileHandler.single('documents'), (0, _expressValidator.checkSchema)(_documentCreateNew["default"]), _validator.checkSchemaValidation, _document.createNewFile, _document.uploadFiles], function (req, res) {
  res.status(200).json({
    document: res.locals.file
  });
});
router.route('/own')
/**
 * @api {get} /document/own Own documents
 * @apiName documentGetOwn
 * @apiGroup Document
 * @apiDescription Returns the users documents
 * @apiSuccess {Array} docs User documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getOwnFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
});
router.route('/shared')
/**
 * @api {get} /document/shared Shared documents
 * @apiName documentGetShared
 * @apiGroup Document
 * @apiDescription Returns the documents shared with the user
 * @apiSuccess {Array} sharedDocs Shared documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getSharedFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
});
router.route('/comment/:fileid')
/**
 * @api {post} /document/comment/:fileid Add comment to file log
 * @apiName documentAddComment
 * @apiGroup Document
 * @apiDescription Returns the file log
 * @apiSuccess {Array} logs Log of the file
 * @apiError (401) {String} PermissionError Not allowed to POST a comment
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile, _document.appendComment], function (req, res) {
  res.status(200).json(res.locals.file.log);
});
router.route('/checkout/:fileid')
/**
 * @api {get} /document/checkout/:fileid Document checkout
 * @apiName documentCheckout
 * @apiGroup Document
 * @apiDescription Checks out document and sends files as ZIP archive
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess (200) {Stream} ZIP file stream
 * @apiError (401) PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile,
/* lockFile ,*/
_document.downloadFile], function (req, res) {
  res.writeHead(200, {
    'Content-Type': res.locals.file.mimetype,
    'Content-disposition': "attachment; filename=".concat(res.locals.file.title, ".").concat(res.locals.file.extension)
  });
  var stream = new _stream.Readable();

  stream._read = function () {};

  stream.push(res.locals.fileBuffer);
  stream.push(null);
  stream.pipe(res);
})
/**
* @api {unlock} /document/checkout/:fileid
* @apiName documentAdminUnlock
* @apiGroup Document
* @apiDescription Unlocks a locked document without actually submitting a new document file. Requires user to be an admin
* @apiParam {String} fileid The fileid as part of the POST URL
* @apiSuccess (200) {Object} The unlocked document
* @apiError (401) PermissionError Not allowed to UNLOCK this file
* @apiError (500) {String} InternalError Something went wrong
*/
.unlock([_authenticate["default"], _authenticate.requireAdmin, (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
router.route('/share/:fileid')
/**
 * @api {post} /document/share/:fileid
 * @apiName documentShareFile
 * @apiGroup Document
 * @apiDescription Shares file with a new user
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiParam {String} whoToShare Username to share the file with. Provided in body or query.
 * @apiSuccess (200) {Object} The updated document
 * @apiError (401) PermissionError Not allowed to edit this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentShare["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.shareFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
router.route('/:fileid')
/**
 * @api {get} /document/:fileid Get single document
 * @apiName documentGetSingle
 * @apiGroup Document
 * @apiDescription Returns the single requested document
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess {Object} document The requested object
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
})
/**
* @api {delete} /document/:fileid Deletes document
* @apiName documentDeleteSingle
* @apiGroup Document
* @apiDescription Deletes the requested document
* @apiParam {String} fileid The fileid as part of the GET URL
* @apiSuccess {Object} document The deleted object
* @apiError (401) {String} PermissionError Not allowed to DELETE this file
* @apiError (500) {String} InternalError Something went wrong
*/
["delete"]([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.deleteSingleFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvZG9jdW1lbnQucm91dGUudHMiXSwibmFtZXMiOlsibXVsdGVyIiwicmVxdWlyZSIsInJvdXRlciIsImV4cHJlc3MiLCJSb3V0ZXIiLCJ1cGxvYWRGaWxlSGFuZGxlciIsInN0b3JhZ2UiLCJtZW1vcnlTdG9yYWdlIiwicm91dGUiLCJnZXQiLCJhdXRoZW50aWNhdGUiLCJyZXF1aXJlQWRtaW4iLCJnZXRBbGxGaWxlcyIsInJlcSIsInJlcyIsInN0YXR1cyIsImpzb24iLCJkb2NzIiwibG9jYWxzIiwiZmlsZXMiLCJwb3N0Iiwic2luZ2xlIiwiY3JlYXRlTmV3IiwiY2hlY2tTY2hlbWFWYWxpZGF0aW9uIiwiY3JlYXRlTmV3RmlsZSIsInVwbG9hZEZpbGVzIiwiZG9jdW1lbnQiLCJmaWxlIiwiZ2V0T3duRmlsZXMiLCJnZXRTaGFyZWRGaWxlcyIsImZpbGVpZCIsImdldFNpbmdsZUZpbGUiLCJjaGVja1Blcm1pc3Npb25Ub0ZpbGUiLCJhcHBlbmRDb21tZW50IiwibG9nIiwiY2hlY2tvdXQiLCJkb3dubG9hZEZpbGUiLCJ3cml0ZUhlYWQiLCJtaW1ldHlwZSIsInRpdGxlIiwiZXh0ZW5zaW9uIiwic3RyZWFtIiwiUmVhZGFibGUiLCJfcmVhZCIsInB1c2giLCJmaWxlQnVmZmVyIiwicGlwZSIsInVubG9jayIsInVubG9ja0ZpbGUiLCJkb2MiLCJzaGFyZSIsInNoYXJlRmlsZSIsImRlbGV0ZVNpbmdsZUZpbGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFWQSxJQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQVlBLElBQUlDLE1BQU0sR0FBR0Msb0JBQVFDLE1BQVIsRUFBYjs7QUFDQSxJQUFJQyxpQkFBaUIsR0FBR0wsTUFBTSxDQUFDO0FBQzNCTSxFQUFBQSxPQUFP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QUFDSSxNQUFKLENBQVdTO0FBQWxCLEdBQXJCO0FBQ0gsQ0FkTDtBQWdCQXpCLE1BQU0sQ0FBQ00sS0FBUCxDQUFhLFVBQWI7QUFDSTs7Ozs7Ozs7OztBQURKLENBV0tDLEdBWEwsQ0FXUyxDQUFDQyx3QkFBRCxFQUFlLG1DQUFZb0IsMEJBQVosQ0FBZixFQUFvQ1AsZ0NBQXBDLEVBQTJEUSx1QkFBM0QsRUFBMEVDLCtCQUExRSxDQVhULEVBVzJHLFVBQUNuQixHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNqSEEsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRWlDLElBQUFBLEdBQUcsRUFBRW5DLEdBQUcsQ0FBQ0ksTUFBSixDQUFXUztBQUFsQixHQUFyQjtBQUNILENBYkw7QUFjSTs7Ozs7Ozs7OztBQWRKLFdBd0JZLENBQUNqQix3QkFBRCxFQUFlLG1DQUFZb0IsMEJBQVosQ0FBZixFQUFvQ1AsZ0NBQXBDLEVBQTJENkIsMEJBQTNELENBeEJaLEVBd0IwRixVQUFDdkMsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDaEdBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVpQyxJQUFBQSxHQUFHLEVBQUVuQyxHQUFHLENBQUNJLE1BQUosQ0FBV1M7QUFBbEIsR0FBckI7QUFDSCxDQTFCTDtBQTRCQTBCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBELE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gXCJleHByZXNzXCJcclxuaW1wb3J0IHsgY2hlY2tTY2hlbWEgfSBmcm9tICdleHByZXNzLXZhbGlkYXRvcidcclxuY29uc3QgbXVsdGVyID0gcmVxdWlyZSgnbXVsdGVyJylcclxuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tIFwic3RyZWFtXCJcclxuXHJcbmltcG9ydCBhdXRoZW50aWNhdGUsIHsgcmVxdWlyZUFkbWluIH0gZnJvbSAnLi4vbGliL2hlbHBlcnMvYXV0aGVudGljYXRlJ1xyXG5pbXBvcnQgeyBnZXRBbGxGaWxlcywgY3JlYXRlTmV3RmlsZSwgdXBsb2FkRmlsZXMsIGdldE93bkZpbGVzLCBnZXRTaGFyZWRGaWxlcywgY2hlY2tQZXJtaXNzaW9uVG9GaWxlLCBsb2NrRmlsZSwgZ2V0U2luZ2xlRmlsZSwgZG93bmxvYWRGaWxlLCB1bmxvY2tGaWxlLCBzaGFyZUZpbGUsIGNoZWNrRmlsZU93bmVyc2hpcCwgZGVsZXRlU2luZ2xlRmlsZSwgYXBwZW5kQ29tbWVudCB9IGZyb20gJy4uL2NvbnRyb2xsZXIvZG9jdW1lbnQuY29udHJvbGxlcic7XHJcblxyXG5pbXBvcnQgY3JlYXRlTmV3IGZyb20gJy4uL2xpYi9yZXF1ZXN0U2NoZW1hcy9kb2N1bWVudC5jcmVhdGVOZXcuanNvbidcclxuaW1wb3J0IGNoZWNrb3V0IGZyb20gJy4uL2xpYi9yZXF1ZXN0U2NoZW1hcy9kb2N1bWVudC5jaGVja291dC5qc29uJ1xyXG5pbXBvcnQgc2hhcmUgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LnNoYXJlLmpzb24nXHJcbmltcG9ydCBmaWxlaWQgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LmZpbGVpZC5qc29uJ1xyXG5pbXBvcnQgeyBjaGVja1NjaGVtYVZhbGlkYXRpb24gfSBmcm9tICcuLi9saWIvaGVscGVycy92YWxpZGF0b3InO1xyXG5cclxubGV0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKClcclxubGV0IHVwbG9hZEZpbGVIYW5kbGVyID0gbXVsdGVyKHtcclxuICAgIHN0b3JhZ2U6IG11bHRlci5tZW1vcnlTdG9yYWdlKClcclxufSlcclxuXHJcbnJvdXRlci5yb3V0ZSgnLycpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50LyBBbGwgZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudHNHZXRBbGxcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIEdldHMgYWxsIGRvY3VtZW50cyBvbiB0aGUgaW5zdGFuY2UuIENhbiBvbmx5IGJlIGFjY2Vzc2VkIGJ5IGFuIGFkbWluLlxyXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdFtdfSBkb2N1bWVudCBBbGwgZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkgTm90QXV0aG9yaXplZCBPbmx5IGFkbWlucyBhcmUgYWxsb3cgdG8gYWNjZXNzIHRoaXMgcmVzc291cmNlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgSW50ZXJuYWxTZXJ2ZXJFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uIHByb2Nlc3NpbmcgeW91ciByZXF1ZXN0XHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgcmVxdWlyZUFkbWluLCBnZXRBbGxGaWxlc10sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jczogcmVzLmxvY2Fscy5maWxlcyB9KVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgKiBAYXBpIHtwb3N0fSAvZG9jdW1lbnQvIE5ldyBkb2N1bWVudFxyXG4gICAgKiBAYXBpTmFtZSBkb2N1bWVudENyZWF0ZVxyXG4gICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICogQGFwaURlc2NyaXB0aW9uIENyZWF0ZXMgYW5kIHVwbG9hZHMgYSBuZXcgZG9jdW1lbnRzIHdpdGggaXRzIGJvZHkuXHJcbiAgICAqIEBhcGlQYXJhbSB7QnVmZmVyW119IGZpbGVzIFBhZ2UocykgZm9yIHRoZSBkb2N1bWVudFxyXG4gICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gdGl0bGUgRG9jdW1lbnRzIHN1YmplY3Qgb3IgdGl0bGVcclxuICAgICogQGFwaVBhcmFtIHtEYXRlfSBkYXRlZCBEYXRlIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB3YXMgcmVjaWV2ZWRcclxuICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGNvbW1lbnQgQ29tbWVudCB0byBhcHBlbmQgdG8gbG9nXHJcbiAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IGRvY3VtZW50IFRoZSBjcmVhdGVkIGRvY3VtZW50XHJcbiAgICAqIEBhcGlFcnJvciAoNDE1KSB7U3RyaW5nfSBGaWxlVHlwZUVycm9yIEZpbGV0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuIFNvIGZhciBvbmx5IFBERnMgYW5kIHBpY3R1cmUgdHlwZXMgYXJlIHN1cHBvcnRlZFxyXG4gICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgKi9cclxuICAgIC5wb3N0KFthdXRoZW50aWNhdGUsIHVwbG9hZEZpbGVIYW5kbGVyLnNpbmdsZSgnZG9jdW1lbnRzJyksIGNoZWNrU2NoZW1hKGNyZWF0ZU5ldyBhcyBhbnkpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGNyZWF0ZU5ld0ZpbGUsIHVwbG9hZEZpbGVzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2N1bWVudDogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvb3duJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvb3duIE93biBkb2N1bWVudHNcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50R2V0T3duXHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBSZXR1cm5zIHRoZSB1c2VycyBkb2N1bWVudHNcclxuICAgICAqIEBhcGlTdWNjZXNzIHtBcnJheX0gZG9jcyBVc2VyIGRvY3VtZW50cyBiYXNpYyBtZXRhZGF0YVxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIHtTdHJpbmd9IFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBHRVQgdGhpcyBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAuZ2V0KFthdXRoZW50aWNhdGUsIGdldE93bkZpbGVzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2NzOiByZXMubG9jYWxzLmZpbGVzIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvc2hhcmVkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvc2hhcmVkIFNoYXJlZCBkb2N1bWVudHNcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50R2V0U2hhcmVkXHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBSZXR1cm5zIHRoZSBkb2N1bWVudHMgc2hhcmVkIHdpdGggdGhlIHVzZXJcclxuICAgICAqIEBhcGlTdWNjZXNzIHtBcnJheX0gc2hhcmVkRG9jcyBTaGFyZWQgZG9jdW1lbnRzIGJhc2ljIG1ldGFkYXRhXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgZ2V0U2hhcmVkRmlsZXNdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvY3M6IHJlcy5sb2NhbHMuZmlsZXMgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy9jb21tZW50LzpmaWxlaWQnKVxyXG4gICAgLyoqXHJcbiAgICAgKiBAYXBpIHtwb3N0fSAvZG9jdW1lbnQvY29tbWVudC86ZmlsZWlkIEFkZCBjb21tZW50IHRvIGZpbGUgbG9nXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudEFkZENvbW1lbnRcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIFJldHVybnMgdGhlIGZpbGUgbG9nXHJcbiAgICAgKiBAYXBpU3VjY2VzcyB7QXJyYXl9IGxvZ3MgTG9nIG9mIHRoZSBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIFBPU1QgYSBjb21tZW50XHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAucG9zdChbYXV0aGVudGljYXRlLCBjaGVja1NjaGVtYShmaWxlaWQpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGdldFNpbmdsZUZpbGUsIGNoZWNrUGVybWlzc2lvblRvRmlsZSwgYXBwZW5kQ29tbWVudF0sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHJlcy5sb2NhbHMuZmlsZS5sb2cpXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvY2hlY2tvdXQvOmZpbGVpZCcpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50L2NoZWNrb3V0LzpmaWxlaWQgRG9jdW1lbnQgY2hlY2tvdXRcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50Q2hlY2tvdXRcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIENoZWNrcyBvdXQgZG9jdW1lbnQgYW5kIHNlbmRzIGZpbGVzIGFzIFpJUCBhcmNoaXZlXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgR0VUIFVSTFxyXG4gICAgICogQGFwaVN1Y2Nlc3MgKDIwMCkge1N0cmVhbX0gWklQIGZpbGUgc3RyZWFtXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkgUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoY2hlY2tvdXQpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGdldFNpbmdsZUZpbGUsIGNoZWNrUGVybWlzc2lvblRvRmlsZSwgLyogbG9ja0ZpbGUgLCovIGRvd25sb2FkRmlsZV0sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy53cml0ZUhlYWQoMjAwLCB7XHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiByZXMubG9jYWxzLmZpbGUubWltZXR5cGUsXHJcbiAgICAgICAgICAgICdDb250ZW50LWRpc3Bvc2l0aW9uJzogYGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSR7cmVzLmxvY2Fscy5maWxlLnRpdGxlfS4ke3Jlcy5sb2NhbHMuZmlsZS5leHRlbnNpb259YCxcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgUmVhZGFibGUoKVxyXG4gICAgICAgIHN0cmVhbS5fcmVhZCA9ICgpID0+IHsgfVxyXG4gICAgICAgIHN0cmVhbS5wdXNoKHJlcy5sb2NhbHMuZmlsZUJ1ZmZlcilcclxuICAgICAgICBzdHJlYW0ucHVzaChudWxsKVxyXG5cclxuICAgICAgICBzdHJlYW0ucGlwZShyZXMpXHJcbiAgICB9KVxyXG4gICAgLyoqXHJcbiAgICAqIEBhcGkge3VubG9ja30gL2RvY3VtZW50L2NoZWNrb3V0LzpmaWxlaWRcclxuICAgICogQGFwaU5hbWUgZG9jdW1lbnRBZG1pblVubG9ja1xyXG4gICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICogQGFwaURlc2NyaXB0aW9uIFVubG9ja3MgYSBsb2NrZWQgZG9jdW1lbnQgd2l0aG91dCBhY3R1YWxseSBzdWJtaXR0aW5nIGEgbmV3IGRvY3VtZW50IGZpbGUuIFJlcXVpcmVzIHVzZXIgdG8gYmUgYW4gYWRtaW5cclxuICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIFBPU1QgVVJMXHJcbiAgICAqIEBhcGlTdWNjZXNzICgyMDApIHtPYmplY3R9IFRoZSB1bmxvY2tlZCBkb2N1bWVudFxyXG4gICAgKiBAYXBpRXJyb3IgKDQwMSkgUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIFVOTE9DSyB0aGlzIGZpbGVcclxuICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICovXHJcbiAgICAudW5sb2NrKFthdXRoZW50aWNhdGUsIHJlcXVpcmVBZG1pbiwgY2hlY2tTY2hlbWEoY2hlY2tvdXQpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGdldFNpbmdsZUZpbGUsIHVubG9ja0ZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvc2hhcmUvOmZpbGVpZCcpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge3Bvc3R9IC9kb2N1bWVudC9zaGFyZS86ZmlsZWlkXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudFNoYXJlRmlsZVxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gU2hhcmVzIGZpbGUgd2l0aCBhIG5ldyB1c2VyXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgUE9TVCBVUkxcclxuICAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSB3aG9Ub1NoYXJlIFVzZXJuYW1lIHRvIHNoYXJlIHRoZSBmaWxlIHdpdGguIFByb3ZpZGVkIGluIGJvZHkgb3IgcXVlcnkuXHJcbiAgICAgKiBAYXBpU3VjY2VzcyAoMjAwKSB7T2JqZWN0fSBUaGUgdXBkYXRlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBlZGl0IHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLnBvc3QoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoc2hhcmUpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGdldFNpbmdsZUZpbGUsIHNoYXJlRmlsZV0sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jOiByZXMubG9jYWxzLmZpbGUgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy86ZmlsZWlkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvOmZpbGVpZCBHZXQgc2luZ2xlIGRvY3VtZW50XHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudEdldFNpbmdsZVxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gUmV0dXJucyB0aGUgc2luZ2xlIHJlcXVlc3RlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIEdFVCBVUkxcclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IGRvY3VtZW50IFRoZSByZXF1ZXN0ZWQgb2JqZWN0XHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoZmlsZWlkKSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBnZXRTaW5nbGVGaWxlLCBjaGVja1Blcm1pc3Npb25Ub0ZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG4gICAgLyoqXHJcbiAgICAqIEBhcGkge2RlbGV0ZX0gL2RvY3VtZW50LzpmaWxlaWQgRGVsZXRlcyBkb2N1bWVudFxyXG4gICAgKiBAYXBpTmFtZSBkb2N1bWVudERlbGV0ZVNpbmdsZVxyXG4gICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICogQGFwaURlc2NyaXB0aW9uIERlbGV0ZXMgdGhlIHJlcXVlc3RlZCBkb2N1bWVudFxyXG4gICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgR0VUIFVSTFxyXG4gICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSBkb2N1bWVudCBUaGUgZGVsZXRlZCBvYmplY3RcclxuICAgICogQGFwaUVycm9yICg0MDEpIHtTdHJpbmd9IFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBERUxFVEUgdGhpcyBmaWxlXHJcbiAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAqL1xyXG4gICAgLmRlbGV0ZShbYXV0aGVudGljYXRlLCBjaGVja1NjaGVtYShmaWxlaWQpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGRlbGV0ZVNpbmdsZUZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXIiXX0=