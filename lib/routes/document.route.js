"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _express = _interopRequireDefault(require("express"));

var _expressValidator = require("express-validator");

var _stream = require("stream");

var _authenticate = _interopRequireWildcard(require("../lib/helpers/authenticate"));

var _document = require("../controller/document.controller");

var _documentCreateNew = _interopRequireDefault(require("../lib/requestSchemas/document.createNew.json"));

var _documentCheckout = _interopRequireDefault(require("../lib/requestSchemas/document.checkout.json"));

var _documentShare = _interopRequireDefault(require("../lib/requestSchemas/document.share.json"));

var _documentFileid = _interopRequireDefault(require("../lib/requestSchemas/document.fileid.json"));

var _validator = require("../lib/helpers/validator");

var multer = require('multer');

var router = _express["default"].Router();

var uploadFileHandler = multer({
  storage: multer.memoryStorage()
});
router.route('/')
/**
 * @api {get} /document/ All documents
 * @apiName documentsGetAll
 * @apiGroup Document
 * @apiDescription Gets all documents on the instance. Can only be accessed by an admin.
 * @apiSuccess {Object[]} document All documents
 * @apiError (401) NotAuthorized Only admins are allow to access this ressource
 * @apiError (500) InternalServerError Something went wron processing your request
 */
.get([_authenticate["default"], _authenticate.requireAdmin, _document.getAllFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
})
/**
* @api {post} /document/ New document
* @apiName documentCreate
* @apiGroup Document
* @apiDescription Creates and uploads a new documents with its body.
* @apiParam {Buffer[]} files Page(s) for the document
* @apiParam {String} title Documents subject or title
* @apiParam {Date} dated Date the original document was recieved
* @apiParam {String} comment Comment to append to log
* @apiSuccess {Object} document The created document
* @apiError (415) {String} FileTypeError Filetype is not supported. So far only PDFs and picture types are supported
* @apiError (500) {String} InternalError Something went wrong
*/
.post([_authenticate["default"], uploadFileHandler.single('documents'), (0, _expressValidator.checkSchema)(_documentCreateNew["default"]), _validator.checkSchemaValidation, _document.createNewFile, _document.uploadFiles], function (req, res) {
  res.status(200).json({
    document: res.locals.file
  });
});
router.route('/own')
/**
 * @api {get} /document/own Own documents
 * @apiName documentGetOwn
 * @apiGroup Document
 * @apiDescription Returns the users documents
 * @apiSuccess {Array} docs User documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getOwnFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
});
router.route('/shared')
/**
 * @api {get} /document/shared Shared documents
 * @apiName documentGetShared
 * @apiGroup Document
 * @apiDescription Returns the documents shared with the user
 * @apiSuccess {Array} sharedDocs Shared documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getSharedFiles], function (req, res) {
  res.status(200).json({
    docs: res.locals.files
  });
});
router.route('/checkout/:fileid')
/**
 * @api {get} /document/checkout/:fileid Document checkout
 * @apiName documentCheckout
 * @apiGroup Document
 * @apiDescription Checks out document and sends files as ZIP archive
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess (200) {Stream} ZIP file stream
 * @apiError (401) PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile,
/* lockFile ,*/
_document.downloadFile], function (req, res) {
  res.writeHead(200, {
    'Content-Type': res.locals.file.mimetype,
    'Content-disposition': "attachment; filename=".concat(res.locals.file.title, ".").concat(res.locals.file.extension)
  });
  var stream = new _stream.Readable();

  stream._read = function () {};

  stream.push(res.locals.fileBuffer);
  stream.push(null);
  stream.pipe(res);
})
/**
 * @api {post} /document/checkout/:fileid
 * @apiName documentCheckin
 * @apiGroup Document
 * @apiDescription Accepts an upload for a locked file and unlocks said file
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiSuccess (200) {Object} The uploaded document
 * @apiError (401) PermissionError Not allowed to POST this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile, uploadFileHandler.array('documents'), _document.uploadFiles, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
})
/**
* @api {unlock} /document/checkout/:fileid
* @apiName documentAdminUnlock
* @apiGroup Document
* @apiDescription Unlocks a locked document without actually submitting a new document file. Requires user to be an admin
* @apiParam {String} fileid The fileid as part of the POST URL
* @apiSuccess (200) {Object} The unlocked document
* @apiError (401) PermissionError Not allowed to UNLOCK this file
* @apiError (500) {String} InternalError Something went wrong
*/
.unlock([_authenticate["default"], _authenticate.requireAdmin, (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
router.route('/share/:fileid')
/**
 * @api {post} /document/share/:fileid
 * @apiName documentShareFile
 * @apiGroup Document
 * @apiDescription Shares file with a new user
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiParam {String} whoToShare Username to share the file with. Provided in body or query.
 * @apiSuccess (200) {Object} The updated document
 * @apiError (401) PermissionError Not allowed to edit this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentShare["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.shareFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
router.route('/:fileid')
/**
 * @api {get} /document/:fileid Get single document
 * @apiName documentGetSingle
 * @apiGroup Document
 * @apiDescription Returns the single requested document
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess {Object} document The requested object
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.getSingleFile, _document.checkPermissionToFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
})
/**
* @api {delete} /document/:fileid Deletes document
* @apiName documentDeleteSingle
* @apiGroup Document
* @apiDescription Deletes the requested document
* @apiParam {String} fileid The fileid as part of the GET URL
* @apiSuccess {Object} document The deleted object
* @apiError (401) {String} PermissionError Not allowed to DELETE this file
* @apiError (500) {String} InternalError Something went wrong
*/
["delete"]([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentFileid["default"]), _validator.checkSchemaValidation, _document.deleteSingleFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.file
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvZG9jdW1lbnQucm91dGUudHMiXSwibmFtZXMiOlsibXVsdGVyIiwicmVxdWlyZSIsInJvdXRlciIsImV4cHJlc3MiLCJSb3V0ZXIiLCJ1cGxvYWRGaWxlSGFuZGxlciIsInN0b3JhZ2UiLCJtZW1vcnlTdG9yYWdlIiwicm91dGUiLCJnZXQiLCJhdXRoZW50aWNhdGUiLCJyZXF1aXJlQWRtaW4iLCJnZXRBbGxGaWxlcyIsInJlcSIsInJlcyIsInN0YXR1cyIsImpzb24iLCJkb2NzIiwibG9jYWxzIiwiZmlsZXMiLCJwb3N0Iiwic2luZ2xlIiwiY3JlYXRlTmV3IiwiY2hlY2tTY2hlbWFWYWxpZGF0aW9uIiwiY3JlYXRlTmV3RmlsZSIsInVwbG9hZEZpbGVzIiwiZG9jdW1lbnQiLCJmaWxlIiwiZ2V0T3duRmlsZXMiLCJnZXRTaGFyZWRGaWxlcyIsImNoZWNrb3V0IiwiZ2V0U2luZ2xlRmlsZSIsImNoZWNrUGVybWlzc2lvblRvRmlsZSIsImRvd25sb2FkRmlsZSIsIndyaXRlSGVhZCIsIm1pbWV0eXBlIiwidGl0bGUiLCJleHRlbnNpb24iLCJzdHJlYW0iLCJSZWFkYWJsZSIsIl9yZWFkIiwicHVzaCIsImZpbGVCdWZmZXIiLCJwaXBlIiwiYXJyYXkiLCJ1bmxvY2tGaWxlIiwiZG9jIiwidW5sb2NrIiwic2hhcmUiLCJzaGFyZUZpbGUiLCJmaWxlaWQiLCJkZWxldGVTaW5nbGVGaWxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBVkEsSUFBTUEsTUFBTSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFZQSxJQUFJQyxNQUFNLEdBQUdDLG9CQUFRQyxNQUFSLEVBQWI7O0FBQ0EsSUFBSUMsaUJBQWlCLEdBQUdMLE1BQU0sQ0FBQztBQUMzQk0sRUFBQUEsT0FBTyxFQUFFTixNQUFNLENBQUNPLGFBQVA7QUFEa0IsQ0FBRCxDQUE5QjtBQUlBTCxNQUFNLENBQUNNLEtBQVAsQ0FBYSxHQUFiO0FBQ0k7Ozs7Ozs7OztBQURKLENBVUtDLEdBVkwsQ0FVUyxDQUFDQyx3QkFBRCxFQUFlQywwQkFBZixFQUE2QkMscUJBQTdCLENBVlQsRUFVb0QsVUFBQ0MsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDMURBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVDLElBQUFBLElBQUksRUFBRUgsR0FBRyxDQUFDSSxNQUFKLENBQVdDO0FBQW5CLEdBQXJCO0FBQ0gsQ0FaTDtBQWFJOzs7Ozs7Ozs7Ozs7O0FBYkosQ0EwQktDLElBMUJMLENBMEJVLENBQUNWLHdCQUFELEVBQWVMLGlCQUFpQixDQUFDZ0IsTUFBbEIsQ0FBeUIsV0FBekIsQ0FBZixFQUFzRCxtQ0FBWUMsNkJBQVosQ0FBdEQsRUFBcUZDLGdDQUFyRixFQUE0R0MsdUJBQTVHLEVBQTJIQyxxQkFBM0gsQ0ExQlYsRUEwQm1KLFVBQUNaLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ3pKQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFVSxJQUFBQSxRQUFRLEVBQUVaLEdBQUcsQ0FBQ0ksTUFBSixDQUFXUztBQUF2QixHQUFyQjtBQUNILENBNUJMO0FBOEJBekIsTUFBTSxDQUFDTSxLQUFQLENBQWEsTUFBYjtBQUNJOzs7Ozs7Ozs7QUFESixDQVVLQyxHQVZMLENBVVMsQ0FBQ0Msd0JBQUQsRUFBZWtCLHFCQUFmLENBVlQsRUFVc0MsVUFBQ2YsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDNUNBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVDLElBQUFBLElBQUksRUFBRUgsR0FBRyxDQUFDSSxNQUFKLENBQVdDO0FBQW5CLEdBQXJCO0FBQ0gsQ0FaTDtBQWNBakIsTUFBTSxDQUFDTSxLQUFQLENBQWEsU0FBYjtBQUNJOzs7Ozs7Ozs7QUFESixDQVVLQyxHQVZMLENBVVMsQ0FBQ0Msd0JBQUQsRUFBZW1CLHdCQUFmLENBVlQsRUFVeUMsVUFBQ2hCLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQy9DQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFQyxJQUFBQSxJQUFJLEVBQUVILEdBQUcsQ0FBQ0ksTUFBSixDQUFXQztBQUFuQixHQUFyQjtBQUNILENBWkw7QUFjQWpCLE1BQU0sQ0FBQ00sS0FBUCxDQUFhLG1CQUFiO0FBQ0k7Ozs7Ozs7Ozs7QUFESixDQVdLQyxHQVhMLENBV1MsQ0FBQ0Msd0JBQUQsRUFBZSxtQ0FBWW9CLDRCQUFaLENBQWYsRUFBc0NQLGdDQUF0QyxFQUE2RFEsdUJBQTdELEVBQTRFQywrQkFBNUU7QUFBbUc7QUFBZ0JDLHNCQUFuSCxDQVhULEVBVzJJLFVBQUNwQixHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNqSkEsRUFBQUEsR0FBRyxDQUFDb0IsU0FBSixDQUFjLEdBQWQsRUFBbUI7QUFDZixvQkFBZ0JwQixHQUFHLENBQUNJLE1BQUosQ0FBV1MsSUFBWCxDQUFnQlEsUUFEakI7QUFFZiwwREFBK0NyQixHQUFHLENBQUNJLE1BQUosQ0FBV1MsSUFBWCxDQUFnQlMsS0FBL0QsY0FBd0V0QixHQUFHLENBQUNJLE1BQUosQ0FBV1MsSUFBWCxDQUFnQlUsU0FBeEY7QUFGZSxHQUFuQjtBQUtBLE1BQU1DLE1BQU0sR0FBRyxJQUFJQyxnQkFBSixFQUFmOztBQUNBRCxFQUFBQSxNQUFNLENBQUNFLEtBQVAsR0FBZSxZQUFNLENBQUcsQ0FBeEI7O0FBQ0FGLEVBQUFBLE1BQU0sQ0FBQ0csSUFBUCxDQUFZM0IsR0FBRyxDQUFDSSxNQUFKLENBQVd3QixVQUF2QjtBQUNBSixFQUFBQSxNQUFNLENBQUNHLElBQVAsQ0FBWSxJQUFaO0FBRUFILEVBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZN0IsR0FBWjtBQUNILENBdkJMO0FBd0JJOzs7Ozs7Ozs7O0FBeEJKLENBa0NLTSxJQWxDTCxDQWtDVSxDQUFDVix3QkFBRCxFQUFlLG1DQUFZb0IsNEJBQVosQ0FBZixFQUE2Q1AsZ0NBQTdDLEVBQW9FUSx1QkFBcEUsRUFBbUZDLCtCQUFuRixFQUEwRzNCLGlCQUFpQixDQUFDdUMsS0FBbEIsQ0FBd0IsV0FBeEIsQ0FBMUcsRUFBZ0puQixxQkFBaEosRUFBNkpvQixvQkFBN0osQ0FsQ1YsRUFrQ29MLFVBQUNoQyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUMxTEEsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRThCLElBQUFBLEdBQUcsRUFBRWhDLEdBQUcsQ0FBQ0ksTUFBSixDQUFXUztBQUFsQixHQUFyQjtBQUNILENBcENMO0FBcUNJOzs7Ozs7Ozs7O0FBckNKLENBK0NLb0IsTUEvQ0wsQ0ErQ1ksQ0FBQ3JDLHdCQUFELEVBQWVDLDBCQUFmLEVBQTZCLG1DQUFZbUIsNEJBQVosQ0FBN0IsRUFBb0RQLGdDQUFwRCxFQUEyRVEsdUJBQTNFLEVBQTBGYyxvQkFBMUYsQ0EvQ1osRUErQ21ILFVBQUNoQyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUN6SEEsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRThCLElBQUFBLEdBQUcsRUFBRWhDLEdBQUcsQ0FBQ0ksTUFBSixDQUFXUztBQUFsQixHQUFyQjtBQUNILENBakRMO0FBbURBekIsTUFBTSxDQUFDTSxLQUFQLENBQWEsZ0JBQWI7QUFDSTs7Ozs7Ozs7Ozs7QUFESixDQVlLWSxJQVpMLENBWVUsQ0FBQ1Ysd0JBQUQsRUFBZSxtQ0FBWXNDLHlCQUFaLENBQWYsRUFBbUN6QixnQ0FBbkMsRUFBMERRLHVCQUExRCxFQUF5RWtCLG1CQUF6RSxDQVpWLEVBWStGLFVBQUNwQyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNyR0EsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRThCLElBQUFBLEdBQUcsRUFBRWhDLEdBQUcsQ0FBQ0ksTUFBSixDQUFXUztBQUFsQixHQUFyQjtBQUNILENBZEw7QUFnQkF6QixNQUFNLENBQUNNLEtBQVAsQ0FBYSxVQUFiO0FBQ0k7Ozs7Ozs7Ozs7QUFESixDQVdLQyxHQVhMLENBV1MsQ0FBQ0Msd0JBQUQsRUFBZSxtQ0FBWXdDLDBCQUFaLENBQWYsRUFBb0MzQixnQ0FBcEMsRUFBMkRRLHVCQUEzRCxFQUEwRUMsK0JBQTFFLENBWFQsRUFXMkcsVUFBQ25CLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2pIQSxFQUFBQSxHQUFHLENBQUNDLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFOEIsSUFBQUEsR0FBRyxFQUFFaEMsR0FBRyxDQUFDSSxNQUFKLENBQVdTO0FBQWxCLEdBQXJCO0FBQ0gsQ0FiTDtBQWNJOzs7Ozs7Ozs7O0FBZEosV0F3QlksQ0FBQ2pCLHdCQUFELEVBQWUsbUNBQVl3QywwQkFBWixDQUFmLEVBQW9DM0IsZ0NBQXBDLEVBQTJENEIsMEJBQTNELENBeEJaLEVBd0IwRixVQUFDdEMsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDaEdBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUU4QixJQUFBQSxHQUFHLEVBQUVoQyxHQUFHLENBQUNJLE1BQUosQ0FBV1M7QUFBbEIsR0FBckI7QUFDSCxDQTFCTDtBQTRCQXlCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5ELE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gXCJleHByZXNzXCJcclxuaW1wb3J0IHsgY2hlY2tTY2hlbWEgfSBmcm9tICdleHByZXNzLXZhbGlkYXRvcidcclxuY29uc3QgbXVsdGVyID0gcmVxdWlyZSgnbXVsdGVyJylcclxuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tIFwic3RyZWFtXCJcclxuXHJcbmltcG9ydCBhdXRoZW50aWNhdGUsIHsgcmVxdWlyZUFkbWluIH0gZnJvbSAnLi4vbGliL2hlbHBlcnMvYXV0aGVudGljYXRlJ1xyXG5pbXBvcnQgeyBnZXRBbGxGaWxlcywgY3JlYXRlTmV3RmlsZSwgdXBsb2FkRmlsZXMsIGdldE93bkZpbGVzLCBnZXRTaGFyZWRGaWxlcywgY2hlY2tQZXJtaXNzaW9uVG9GaWxlLCBsb2NrRmlsZSwgZ2V0U2luZ2xlRmlsZSwgZG93bmxvYWRGaWxlLCB1bmxvY2tGaWxlLCBzaGFyZUZpbGUsIGNoZWNrRmlsZU93bmVyc2hpcCwgZGVsZXRlU2luZ2xlRmlsZSB9IGZyb20gJy4uL2NvbnRyb2xsZXIvZG9jdW1lbnQuY29udHJvbGxlcic7XHJcblxyXG5pbXBvcnQgY3JlYXRlTmV3IGZyb20gJy4uL2xpYi9yZXF1ZXN0U2NoZW1hcy9kb2N1bWVudC5jcmVhdGVOZXcuanNvbidcclxuaW1wb3J0IGNoZWNrb3V0IGZyb20gJy4uL2xpYi9yZXF1ZXN0U2NoZW1hcy9kb2N1bWVudC5jaGVja291dC5qc29uJ1xyXG5pbXBvcnQgc2hhcmUgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LnNoYXJlLmpzb24nXHJcbmltcG9ydCBmaWxlaWQgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LmZpbGVpZC5qc29uJ1xyXG5pbXBvcnQgeyBjaGVja1NjaGVtYVZhbGlkYXRpb24gfSBmcm9tICcuLi9saWIvaGVscGVycy92YWxpZGF0b3InO1xyXG5cclxubGV0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKClcclxubGV0IHVwbG9hZEZpbGVIYW5kbGVyID0gbXVsdGVyKHtcclxuICAgIHN0b3JhZ2U6IG11bHRlci5tZW1vcnlTdG9yYWdlKClcclxufSlcclxuXHJcbnJvdXRlci5yb3V0ZSgnLycpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50LyBBbGwgZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudHNHZXRBbGxcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIEdldHMgYWxsIGRvY3VtZW50cyBvbiB0aGUgaW5zdGFuY2UuIENhbiBvbmx5IGJlIGFjY2Vzc2VkIGJ5IGFuIGFkbWluLlxyXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdFtdfSBkb2N1bWVudCBBbGwgZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkgTm90QXV0aG9yaXplZCBPbmx5IGFkbWlucyBhcmUgYWxsb3cgdG8gYWNjZXNzIHRoaXMgcmVzc291cmNlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgSW50ZXJuYWxTZXJ2ZXJFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uIHByb2Nlc3NpbmcgeW91ciByZXF1ZXN0XHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgcmVxdWlyZUFkbWluLCBnZXRBbGxGaWxlc10sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jczogcmVzLmxvY2Fscy5maWxlcyB9KVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgKiBAYXBpIHtwb3N0fSAvZG9jdW1lbnQvIE5ldyBkb2N1bWVudFxyXG4gICAgKiBAYXBpTmFtZSBkb2N1bWVudENyZWF0ZVxyXG4gICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICogQGFwaURlc2NyaXB0aW9uIENyZWF0ZXMgYW5kIHVwbG9hZHMgYSBuZXcgZG9jdW1lbnRzIHdpdGggaXRzIGJvZHkuXHJcbiAgICAqIEBhcGlQYXJhbSB7QnVmZmVyW119IGZpbGVzIFBhZ2UocykgZm9yIHRoZSBkb2N1bWVudFxyXG4gICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gdGl0bGUgRG9jdW1lbnRzIHN1YmplY3Qgb3IgdGl0bGVcclxuICAgICogQGFwaVBhcmFtIHtEYXRlfSBkYXRlZCBEYXRlIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB3YXMgcmVjaWV2ZWRcclxuICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGNvbW1lbnQgQ29tbWVudCB0byBhcHBlbmQgdG8gbG9nXHJcbiAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IGRvY3VtZW50IFRoZSBjcmVhdGVkIGRvY3VtZW50XHJcbiAgICAqIEBhcGlFcnJvciAoNDE1KSB7U3RyaW5nfSBGaWxlVHlwZUVycm9yIEZpbGV0eXBlIGlzIG5vdCBzdXBwb3J0ZWQuIFNvIGZhciBvbmx5IFBERnMgYW5kIHBpY3R1cmUgdHlwZXMgYXJlIHN1cHBvcnRlZFxyXG4gICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgKi9cclxuICAgIC5wb3N0KFthdXRoZW50aWNhdGUsIHVwbG9hZEZpbGVIYW5kbGVyLnNpbmdsZSgnZG9jdW1lbnRzJyksIGNoZWNrU2NoZW1hKGNyZWF0ZU5ldyBhcyBhbnkpLCBjaGVja1NjaGVtYVZhbGlkYXRpb24sIGNyZWF0ZU5ld0ZpbGUsIHVwbG9hZEZpbGVzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2N1bWVudDogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvb3duJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvb3duIE93biBkb2N1bWVudHNcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50R2V0T3duXHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBSZXR1cm5zIHRoZSB1c2VycyBkb2N1bWVudHNcclxuICAgICAqIEBhcGlTdWNjZXNzIHtBcnJheX0gZG9jcyBVc2VyIGRvY3VtZW50cyBiYXNpYyBtZXRhZGF0YVxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIHtTdHJpbmd9IFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBHRVQgdGhpcyBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAuZ2V0KFthdXRoZW50aWNhdGUsIGdldE93bkZpbGVzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2NzOiByZXMubG9jYWxzLmZpbGVzIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvc2hhcmVkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvc2hhcmVkIFNoYXJlZCBkb2N1bWVudHNcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50R2V0U2hhcmVkXHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBSZXR1cm5zIHRoZSBkb2N1bWVudHMgc2hhcmVkIHdpdGggdGhlIHVzZXJcclxuICAgICAqIEBhcGlTdWNjZXNzIHtBcnJheX0gc2hhcmVkRG9jcyBTaGFyZWQgZG9jdW1lbnRzIGJhc2ljIG1ldGFkYXRhXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgZ2V0U2hhcmVkRmlsZXNdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvY3M6IHJlcy5sb2NhbHMuZmlsZXMgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy9jaGVja291dC86ZmlsZWlkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvY2hlY2tvdXQvOmZpbGVpZCBEb2N1bWVudCBjaGVja291dFxyXG4gICAgICogQGFwaU5hbWUgZG9jdW1lbnRDaGVja291dFxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gQ2hlY2tzIG91dCBkb2N1bWVudCBhbmQgc2VuZHMgZmlsZXMgYXMgWklQIGFyY2hpdmVcclxuICAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSBmaWxlaWQgVGhlIGZpbGVpZCBhcyBwYXJ0IG9mIHRoZSBHRVQgVVJMXHJcbiAgICAgKiBAYXBpU3VjY2VzcyAoMjAwKSB7U3RyZWFtfSBaSVAgZmlsZSBzdHJlYW1cclxuICAgICAqIEBhcGlFcnJvciAoNDAxKSBQZXJtaXNzaW9uRXJyb3IgTm90IGFsbG93ZWQgdG8gR0VUIHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLmdldChbYXV0aGVudGljYXRlLCBjaGVja1NjaGVtYShjaGVja291dCksIGNoZWNrU2NoZW1hVmFsaWRhdGlvbiwgZ2V0U2luZ2xlRmlsZSwgY2hlY2tQZXJtaXNzaW9uVG9GaWxlLCAvKiBsb2NrRmlsZSAsKi8gZG93bmxvYWRGaWxlXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHtcclxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IHJlcy5sb2NhbHMuZmlsZS5taW1ldHlwZSxcclxuICAgICAgICAgICAgJ0NvbnRlbnQtZGlzcG9zaXRpb24nOiBgYXR0YWNobWVudDsgZmlsZW5hbWU9JHtyZXMubG9jYWxzLmZpbGUudGl0bGV9LiR7cmVzLmxvY2Fscy5maWxlLmV4dGVuc2lvbn1gLFxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBSZWFkYWJsZSgpXHJcbiAgICAgICAgc3RyZWFtLl9yZWFkID0gKCkgPT4geyB9XHJcbiAgICAgICAgc3RyZWFtLnB1c2gocmVzLmxvY2Fscy5maWxlQnVmZmVyKVxyXG4gICAgICAgIHN0cmVhbS5wdXNoKG51bGwpXHJcblxyXG4gICAgICAgIHN0cmVhbS5waXBlKHJlcylcclxuICAgIH0pXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge3Bvc3R9IC9kb2N1bWVudC9jaGVja291dC86ZmlsZWlkXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudENoZWNraW5cclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIEFjY2VwdHMgYW4gdXBsb2FkIGZvciBhIGxvY2tlZCBmaWxlIGFuZCB1bmxvY2tzIHNhaWQgZmlsZVxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIFBPU1QgVVJMXHJcbiAgICAgKiBAYXBpU3VjY2VzcyAoMjAwKSB7T2JqZWN0fSBUaGUgdXBsb2FkZWQgZG9jdW1lbnRcclxuICAgICAqIEBhcGlFcnJvciAoNDAxKSBQZXJtaXNzaW9uRXJyb3IgTm90IGFsbG93ZWQgdG8gUE9TVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5wb3N0KFthdXRoZW50aWNhdGUsIGNoZWNrU2NoZW1hKGNoZWNrb3V0IGFzIGFueSksIGNoZWNrU2NoZW1hVmFsaWRhdGlvbiwgZ2V0U2luZ2xlRmlsZSwgY2hlY2tQZXJtaXNzaW9uVG9GaWxlLCB1cGxvYWRGaWxlSGFuZGxlci5hcnJheSgnZG9jdW1lbnRzJyksIHVwbG9hZEZpbGVzLCB1bmxvY2tGaWxlXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2M6IHJlcy5sb2NhbHMuZmlsZSB9KVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgKiBAYXBpIHt1bmxvY2t9IC9kb2N1bWVudC9jaGVja291dC86ZmlsZWlkXHJcbiAgICAqIEBhcGlOYW1lIGRvY3VtZW50QWRtaW5VbmxvY2tcclxuICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAqIEBhcGlEZXNjcmlwdGlvbiBVbmxvY2tzIGEgbG9ja2VkIGRvY3VtZW50IHdpdGhvdXQgYWN0dWFsbHkgc3VibWl0dGluZyBhIG5ldyBkb2N1bWVudCBmaWxlLiBSZXF1aXJlcyB1c2VyIHRvIGJlIGFuIGFkbWluXHJcbiAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSBmaWxlaWQgVGhlIGZpbGVpZCBhcyBwYXJ0IG9mIHRoZSBQT1NUIFVSTFxyXG4gICAgKiBAYXBpU3VjY2VzcyAoMjAwKSB7T2JqZWN0fSBUaGUgdW5sb2NrZWQgZG9jdW1lbnRcclxuICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBVTkxPQ0sgdGhpcyBmaWxlXHJcbiAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAqL1xyXG4gICAgLnVubG9jayhbYXV0aGVudGljYXRlLCByZXF1aXJlQWRtaW4sIGNoZWNrU2NoZW1hKGNoZWNrb3V0KSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBnZXRTaW5nbGVGaWxlLCB1bmxvY2tGaWxlXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2M6IHJlcy5sb2NhbHMuZmlsZSB9KVxyXG4gICAgfSlcclxuXHJcbnJvdXRlci5yb3V0ZSgnL3NoYXJlLzpmaWxlaWQnKVxyXG4gICAgLyoqXHJcbiAgICAgKiBAYXBpIHtwb3N0fSAvZG9jdW1lbnQvc2hhcmUvOmZpbGVpZFxyXG4gICAgICogQGFwaU5hbWUgZG9jdW1lbnRTaGFyZUZpbGVcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIFNoYXJlcyBmaWxlIHdpdGggYSBuZXcgdXNlclxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIFBPU1QgVVJMXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gd2hvVG9TaGFyZSBVc2VybmFtZSB0byBzaGFyZSB0aGUgZmlsZSB3aXRoLiBQcm92aWRlZCBpbiBib2R5IG9yIHF1ZXJ5LlxyXG4gICAgICogQGFwaVN1Y2Nlc3MgKDIwMCkge09iamVjdH0gVGhlIHVwZGF0ZWQgZG9jdW1lbnRcclxuICAgICAqIEBhcGlFcnJvciAoNDAxKSBQZXJtaXNzaW9uRXJyb3IgTm90IGFsbG93ZWQgdG8gZWRpdCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5wb3N0KFthdXRoZW50aWNhdGUsIGNoZWNrU2NoZW1hKHNoYXJlKSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBnZXRTaW5nbGVGaWxlLCBzaGFyZUZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5maWxlIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvOmZpbGVpZCcpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50LzpmaWxlaWQgR2V0IHNpbmdsZSBkb2N1bWVudFxyXG4gICAgICogQGFwaU5hbWUgZG9jdW1lbnRHZXRTaW5nbGVcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIFJldHVybnMgdGhlIHNpbmdsZSByZXF1ZXN0ZWQgZG9jdW1lbnRcclxuICAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSBmaWxlaWQgVGhlIGZpbGVpZCBhcyBwYXJ0IG9mIHRoZSBHRVQgVVJMXHJcbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSBkb2N1bWVudCBUaGUgcmVxdWVzdGVkIG9iamVjdFxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIHtTdHJpbmd9IFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBHRVQgdGhpcyBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAuZ2V0KFthdXRoZW50aWNhdGUsIGNoZWNrU2NoZW1hKGZpbGVpZCksIGNoZWNrU2NoZW1hVmFsaWRhdGlvbiwgZ2V0U2luZ2xlRmlsZSwgY2hlY2tQZXJtaXNzaW9uVG9GaWxlXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2M6IHJlcy5sb2NhbHMuZmlsZSB9KVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgKiBAYXBpIHtkZWxldGV9IC9kb2N1bWVudC86ZmlsZWlkIERlbGV0ZXMgZG9jdW1lbnRcclxuICAgICogQGFwaU5hbWUgZG9jdW1lbnREZWxldGVTaW5nbGVcclxuICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAqIEBhcGlEZXNjcmlwdGlvbiBEZWxldGVzIHRoZSByZXF1ZXN0ZWQgZG9jdW1lbnRcclxuICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIEdFVCBVUkxcclxuICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gZG9jdW1lbnQgVGhlIGRlbGV0ZWQgb2JqZWN0XHJcbiAgICAqIEBhcGlFcnJvciAoNDAxKSB7U3RyaW5nfSBQZXJtaXNzaW9uRXJyb3IgTm90IGFsbG93ZWQgdG8gREVMRVRFIHRoaXMgZmlsZVxyXG4gICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgKi9cclxuICAgIC5kZWxldGUoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoZmlsZWlkKSwgY2hlY2tTY2hlbWFWYWxpZGF0aW9uLCBkZWxldGVTaW5nbGVGaWxlXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2M6IHJlcy5sb2NhbHMuZmlsZSB9KVxyXG4gICAgfSlcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gcm91dGVyIl19