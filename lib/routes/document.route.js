"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _express = _interopRequireDefault(require("express"));

var _expressValidator = require("express-validator");

var _authenticate = _interopRequireWildcard(require("../lib/helpers/authenticate"));

var _document = require("../controller/document.controller");

var _documentCreateNew = _interopRequireDefault(require("../lib/requestSchemas/document.createNew.json"));

var _documentCheckout = _interopRequireDefault(require("../lib/requestSchemas/document.checkout.json"));

var _documentShare = _interopRequireDefault(require("../lib/requestSchemas/document.share.json"));

var multer = require('multer');

var router = _express["default"].Router();

var uploadFileHandler = multer({
  storage: multer.memoryStorage()
});
router.route('/')
/**
 * @api {get} /document/ All documents
 * @apiName documentsGetAll
 * @apiGroup Document
 * @apiDescription Gets all documents on the instance. Can only be accessed by an admin.
 * @apiSuccess {Object[]} document All documents
 * @apiError (401) NotAuthorized Only admins are allow to access this ressource
 * @apiError (500) InternalServerError Something went wron processing your request
 */
.get([_authenticate["default"], _authenticate.requireAdmin, _document.getAllDocuments], function (req, res) {
  res.status(200).json({
    document: res.locals.docs
  });
})
/**
* @api {post} /document/ New document
* @apiName documentCreate
* @apiGroup Document
* @apiDescription Creates and uploads a new documents with its body.
* @apiParam {Buffer[]} files Page(s) for the document
* @apiParam {String} title Documents subject or title
* @apiParam {Date} dated Date the original document was recieved
* @apiParam {String} comment Comment to append to log
* @apiSuccess {Object} document The created document
* @apiError (415) {String} FileTypeError Filetype is not supported. So far only PDFs and picture types are supported
* @apiError (500) {String} InternalError Something went wrong
*/
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCreateNew["default"]), _document.createNewDocument, uploadFileHandler.array('documents'), _document.uploadFiles], function (req, res) {
  res.status(200).json({
    document: res.locals.doc
  });
});
router.route('/:fileid')
/**
 * @api {get} /document/:fileid Get single document
 * @apiName documentGetSingle
 * @apiGroup Document
 * @apiDescription Returns the single requested document
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess {Object} document The requested object
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getSingleDocument, _document.checkFileOwnership], function (req, res) {
  res.status(200).json({
    doc: res.locals.doc
  });
});
router.route('/own')
/**
 * @api {get} /document/own Own documents
 * @apiName documentGetOwn
 * @apiGroup Document
 * @apiDescription Returns the users documents
 * @apiSuccess {Array} docs User documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getOwnDocuments], function (req, res) {
  res.status(200).json({
    docs: res.locals.docs
  });
});
router.route('/shared')
/**
 * @api {get} /document/shared Shared documents
 * @apiName documentGetShared
 * @apiGroup Document
 * @apiDescription Returns the documents shared with the user
 * @apiSuccess {Array} sharedDocs Shared documents basic metadata
 * @apiError (401) {String} PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], _document.getSharedDocuments], function (req, res) {
  res.status(200).json({
    docs: res.locals.docs
  });
});
router.route('/checkout/:fileid')
/**
 * @api {get} /document/checkout/:fileid Document checkout
 * @apiName documentCheckout
 * @apiGroup Document
 * @apiDescription Checks out document and sends files as ZIP archive
 * @apiParam {String} fileid The fileid as part of the GET URL
 * @apiSuccess (200) {Stream} ZIP file stream
 * @apiError (401) PermissionError Not allowed to GET this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.get([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _document.getSingleDocument, _document.checkPermissionToFile, _document.lockFile, _document.downloadFile], function (req, res) {
  res.locals.zip.pipe(res);
  res.locals.zip.finalize();
})
/**
 * @api {post} /document/checkout/:fileid
 * @apiName documentCheckin
 * @apiGroup Document
 * @apiDescription Accepts an upload for a locked file and unlocks said file
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiSuccess (200) {Object} The uploaded document
 * @apiError (401) PermissionError Not allowed to POST this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _document.getSingleDocument, _document.checkPermissionToFile, uploadFileHandler.array('documents'), _document.uploadFiles, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.doc
  });
})
/**
* @api {unlock} /document/checkout/:fileid
* @apiName documentAdminUnlock
* @apiGroup Document
* @apiDescription Unlocks a locked document without actually submitting a new document file. Requires user to be an admin
* @apiParam {String} fileid The fileid as part of the POST URL
* @apiSuccess (200) {Object} The unlocked document
* @apiError (401) PermissionError Not allowed to UNLOCK this file
* @apiError (500) {String} InternalError Something went wrong
*/
.unlock([_authenticate["default"], _authenticate.requireAdmin, (0, _expressValidator.checkSchema)(_documentCheckout["default"]), _document.getSingleDocument, _document.unlockFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.doc
  });
});
router.route('/share/:fileid')
/**
 * @api {post} /document/share/:fileid
 * @apiName documentShareFile
 * @apiGroup Document
 * @apiDescription Shares file with a new user
 * @apiParam {String} fileid The fileid as part of the POST URL
 * @apiParam {String} whoToShare Username to share the file with. Provided in body or query.
 * @apiSuccess (200) {Object} The updated document
 * @apiError (401) PermissionError Not allowed to edit this file
 * @apiError (500) {String} InternalError Something went wrong
 */
.post([_authenticate["default"], (0, _expressValidator.checkSchema)(_documentShare["default"]), _document.getSingleDocument, _document.shareFile], function (req, res) {
  res.status(200).json({
    doc: res.locals.doc
  });
});
module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvZG9jdW1lbnQucm91dGUudHMiXSwibmFtZXMiOlsibXVsdGVyIiwicmVxdWlyZSIsInJvdXRlciIsImV4cHJlc3MiLCJSb3V0ZXIiLCJ1cGxvYWRGaWxlSGFuZGxlciIsInN0b3JhZ2UiLCJtZW1vcnlTdG9yYWdlIiwicm91dGUiLCJnZXQiLCJhdXRoZW50aWNhdGUiLCJyZXF1aXJlQWRtaW4iLCJnZXRBbGxEb2N1bWVudHMiLCJyZXEiLCJyZXMiLCJzdGF0dXMiLCJqc29uIiwiZG9jdW1lbnQiLCJsb2NhbHMiLCJkb2NzIiwicG9zdCIsImNyZWF0ZU5ldyIsImNyZWF0ZU5ld0RvY3VtZW50IiwiYXJyYXkiLCJ1cGxvYWRGaWxlcyIsImRvYyIsImdldFNpbmdsZURvY3VtZW50IiwiY2hlY2tGaWxlT3duZXJzaGlwIiwiZ2V0T3duRG9jdW1lbnRzIiwiZ2V0U2hhcmVkRG9jdW1lbnRzIiwiY2hlY2tvdXQiLCJjaGVja1Blcm1pc3Npb25Ub0ZpbGUiLCJsb2NrRmlsZSIsImRvd25sb2FkRmlsZSIsInppcCIsInBpcGUiLCJmaW5hbGl6ZSIsInVubG9ja0ZpbGUiLCJ1bmxvY2siLCJzaGFyZSIsInNoYXJlRmlsZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOztBQUNBOztBQUdBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQVBBLElBQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBU0EsSUFBSUMsTUFBTSxHQUFHQyxvQkFBUUMsTUFBUixFQUFiOztBQUNBLElBQUlDLGlCQUFpQixHQUFHTCxNQUFNLENBQUM7QUFDM0JNLEVBQUFBLE9BQU8sRUFBRU4sTUFBTSxDQUFDTyxhQUFQO0FBRGtCLENBQUQsQ0FBOUI7QUFJQUwsTUFBTSxDQUFDTSxLQUFQLENBQWEsR0FBYjtBQUNJOzs7Ozs7Ozs7QUFESixDQVVLQyxHQVZMLENBVVMsQ0FBQ0Msd0JBQUQsRUFBZUMsMEJBQWYs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QUFELEVBQU1DLEdBQU4sRUFBYztBQUN2S0EsRUFBQUEsR0FBRyxDQUFDQyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBRVMsSUFBQUEsR0FBRyxFQUFFWCxHQUFHLENBQUNJLE1BQUosQ0FBV087QUFBbEIsR0FBckI7QUFDSCxDQTNCTDtBQTRCSTs7Ozs7Ozs7OztBQTVCSixDQXNDS2EsTUF0Q0wsQ0FzQ1ksQ0FBQzVCLHdCQUFELEVBQWVDLDBCQUFmLEVBQTZCLG1DQUFZbUIsNEJBQVosQ0FBN0IsRUFBb0RKLDJCQUFwRCxFQUF1RVcsb0JBQXZFLENBdENaLEVBc0NnRyxVQUFDeEIsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDdEdBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVTLElBQUFBLEdBQUcsRUFBRVgsR0FBRyxDQUFDSSxNQUFKLENBQVdPO0FBQWxCLEdBQXJCO0FBQ0gsQ0F4Q0w7QUEwQ0F2QixNQUFNLENBQUNNLEtBQVAsQ0FBYSxnQkFBYjtBQUNJOzs7Ozs7Ozs7OztBQURKLENBWUtZLElBWkwsQ0FZVSxDQUFDVix3QkFBRCxFQUFlLG1DQUFZNkIseUJBQVosQ0FBZixFQUFtQ2IsMkJBQW5DLEVBQXNEYyxtQkFBdEQsQ0FaVixFQVk0RSxVQUFDM0IsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDbEZBLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVTLElBQUFBLEdBQUcsRUFBRVgsR0FBRyxDQUFDSSxNQUFKLENBQVdPO0FBQWxCLEdBQXJCO0FBQ0gsQ0FkTDtBQWlCQWdCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnhDLE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gXCJleHByZXNzXCJcclxuaW1wb3J0IHsgY2hlY2tTY2hlbWEgfSBmcm9tICdleHByZXNzLXZhbGlkYXRvcidcclxuY29uc3QgbXVsdGVyID0gcmVxdWlyZSgnbXVsdGVyJylcclxuXHJcbmltcG9ydCBhdXRoZW50aWNhdGUsIHsgcmVxdWlyZUFkbWluIH0gZnJvbSAnLi4vbGliL2hlbHBlcnMvYXV0aGVudGljYXRlJ1xyXG5pbXBvcnQgeyBnZXRBbGxEb2N1bWVudHMsIGNyZWF0ZU5ld0RvY3VtZW50LCB1cGxvYWRGaWxlcywgZ2V0T3duRG9jdW1lbnRzLCBnZXRTaGFyZWREb2N1bWVudHMsIGNoZWNrUGVybWlzc2lvblRvRmlsZSwgbG9ja0ZpbGUsIGdldFNpbmdsZURvY3VtZW50LCBkb3dubG9hZEZpbGUsIHVubG9ja0ZpbGUsIHNoYXJlRmlsZSwgY2hlY2tGaWxlT3duZXJzaGlwIH0gZnJvbSAnLi4vY29udHJvbGxlci9kb2N1bWVudC5jb250cm9sbGVyJztcclxuXHJcbmltcG9ydCBjcmVhdGVOZXcgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LmNyZWF0ZU5ldy5qc29uJ1xyXG5pbXBvcnQgY2hlY2tvdXQgZnJvbSAnLi4vbGliL3JlcXVlc3RTY2hlbWFzL2RvY3VtZW50LmNoZWNrb3V0Lmpzb24nXHJcbmltcG9ydCBzaGFyZSBmcm9tICcuLi9saWIvcmVxdWVzdFNjaGVtYXMvZG9jdW1lbnQuc2hhcmUuanNvbidcclxuXHJcbmxldCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpXHJcbmxldCB1cGxvYWRGaWxlSGFuZGxlciA9IG11bHRlcih7XHJcbiAgICBzdG9yYWdlOiBtdWx0ZXIubWVtb3J5U3RvcmFnZSgpXHJcbn0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy8nKVxyXG4gICAgLyoqXHJcbiAgICAgKiBAYXBpIHtnZXR9IC9kb2N1bWVudC8gQWxsIGRvY3VtZW50c1xyXG4gICAgICogQGFwaU5hbWUgZG9jdW1lbnRzR2V0QWxsXHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBHZXRzIGFsbCBkb2N1bWVudHMgb24gdGhlIGluc3RhbmNlLiBDYW4gb25seSBiZSBhY2Nlc3NlZCBieSBhbiBhZG1pbi5cclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3RbXX0gZG9jdW1lbnQgQWxsIGRvY3VtZW50c1xyXG4gICAgICogQGFwaUVycm9yICg0MDEpIE5vdEF1dGhvcml6ZWQgT25seSBhZG1pbnMgYXJlIGFsbG93IHRvIGFjY2VzcyB0aGlzIHJlc3NvdXJjZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIEludGVybmFsU2VydmVyRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbiBwcm9jZXNzaW5nIHlvdXIgcmVxdWVzdFxyXG4gICAgICovXHJcbiAgICAuZ2V0KFthdXRoZW50aWNhdGUsIHJlcXVpcmVBZG1pbiwgZ2V0QWxsRG9jdW1lbnRzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2N1bWVudDogcmVzLmxvY2Fscy5kb2NzIH0pXHJcbiAgICB9KVxyXG4gICAgLyoqXHJcbiAgICAqIEBhcGkge3Bvc3R9IC9kb2N1bWVudC8gTmV3IGRvY3VtZW50XHJcbiAgICAqIEBhcGlOYW1lIGRvY3VtZW50Q3JlYXRlXHJcbiAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgKiBAYXBpRGVzY3JpcHRpb24gQ3JlYXRlcyBhbmQgdXBsb2FkcyBhIG5ldyBkb2N1bWVudHMgd2l0aCBpdHMgYm9keS5cclxuICAgICogQGFwaVBhcmFtIHtCdWZmZXJbXX0gZmlsZXMgUGFnZShzKSBmb3IgdGhlIGRvY3VtZW50XHJcbiAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSB0aXRsZSBEb2N1bWVudHMgc3ViamVjdCBvciB0aXRsZVxyXG4gICAgKiBAYXBpUGFyYW0ge0RhdGV9IGRhdGVkIERhdGUgdGhlIG9yaWdpbmFsIGRvY3VtZW50IHdhcyByZWNpZXZlZFxyXG4gICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gY29tbWVudCBDb21tZW50IHRvIGFwcGVuZCB0byBsb2dcclxuICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gZG9jdW1lbnQgVGhlIGNyZWF0ZWQgZG9jdW1lbnRcclxuICAgICogQGFwaUVycm9yICg0MTUpIHtTdHJpbmd9IEZpbGVUeXBlRXJyb3IgRmlsZXR5cGUgaXMgbm90IHN1cHBvcnRlZC4gU28gZmFyIG9ubHkgUERGcyBhbmQgcGljdHVyZSB0eXBlcyBhcmUgc3VwcG9ydGVkXHJcbiAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAqL1xyXG4gICAgLnBvc3QoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoY3JlYXRlTmV3IGFzIGFueSksIGNyZWF0ZU5ld0RvY3VtZW50LCB1cGxvYWRGaWxlSGFuZGxlci5hcnJheSgnZG9jdW1lbnRzJyksIHVwbG9hZEZpbGVzXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkb2N1bWVudDogcmVzLmxvY2Fscy5kb2MgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy86ZmlsZWlkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7Z2V0fSAvZG9jdW1lbnQvOmZpbGVpZCBHZXQgc2luZ2xlIGRvY3VtZW50XHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudEdldFNpbmdsZVxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gUmV0dXJucyB0aGUgc2luZ2xlIHJlcXVlc3RlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IGZpbGVpZCBUaGUgZmlsZWlkIGFzIHBhcnQgb2YgdGhlIEdFVCBVUkxcclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IGRvY3VtZW50IFRoZSByZXF1ZXN0ZWQgb2JqZWN0XHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkge1N0cmluZ30gUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgZ2V0U2luZ2xlRG9jdW1lbnQsIGNoZWNrRmlsZU93bmVyc2hpcF0sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jOiByZXMubG9jYWxzLmRvYyB9KVxyXG4gICAgfSlcclxuXHJcbnJvdXRlci5yb3V0ZSgnL293bicpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50L293biBPd24gZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudEdldE93blxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gUmV0dXJucyB0aGUgdXNlcnMgZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpU3VjY2VzcyB7QXJyYXl9IGRvY3MgVXNlciBkb2N1bWVudHMgYmFzaWMgbWV0YWRhdGFcclxuICAgICAqIEBhcGlFcnJvciAoNDAxKSB7U3RyaW5nfSBQZXJtaXNzaW9uRXJyb3IgTm90IGFsbG93ZWQgdG8gR0VUIHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLmdldChbYXV0aGVudGljYXRlLCBnZXRPd25Eb2N1bWVudHNdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvY3M6IHJlcy5sb2NhbHMuZG9jcyB9KVxyXG4gICAgfSlcclxuXHJcbnJvdXRlci5yb3V0ZSgnL3NoYXJlZCcpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50L3NoYXJlZCBTaGFyZWQgZG9jdW1lbnRzXHJcbiAgICAgKiBAYXBpTmFtZSBkb2N1bWVudEdldFNoYXJlZFxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gUmV0dXJucyB0aGUgZG9jdW1lbnRzIHNoYXJlZCB3aXRoIHRoZSB1c2VyXHJcbiAgICAgKiBAYXBpU3VjY2VzcyB7QXJyYXl9IHNoYXJlZERvY3MgU2hhcmVkIGRvY3VtZW50cyBiYXNpYyBtZXRhZGF0YVxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIHtTdHJpbmd9IFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBHRVQgdGhpcyBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAuZ2V0KFthdXRoZW50aWNhdGUsIGdldFNoYXJlZERvY3VtZW50c10sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jczogcmVzLmxvY2Fscy5kb2NzIH0pXHJcbiAgICB9KVxyXG5cclxucm91dGVyLnJvdXRlKCcvY2hlY2tvdXQvOmZpbGVpZCcpXHJcbiAgICAvKipcclxuICAgICAqIEBhcGkge2dldH0gL2RvY3VtZW50L2NoZWNrb3V0LzpmaWxlaWQgRG9jdW1lbnQgY2hlY2tvdXRcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50Q2hlY2tvdXRcclxuICAgICAqIEBhcGlHcm91cCBEb2N1bWVudFxyXG4gICAgICogQGFwaURlc2NyaXB0aW9uIENoZWNrcyBvdXQgZG9jdW1lbnQgYW5kIHNlbmRzIGZpbGVzIGFzIFpJUCBhcmNoaXZlXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgR0VUIFVSTFxyXG4gICAgICogQGFwaVN1Y2Nlc3MgKDIwMCkge1N0cmVhbX0gWklQIGZpbGUgc3RyZWFtXHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkgUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIEdFVCB0aGlzIGZpbGVcclxuICAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAgKi9cclxuICAgIC5nZXQoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoY2hlY2tvdXQpLCBnZXRTaW5nbGVEb2N1bWVudCwgY2hlY2tQZXJtaXNzaW9uVG9GaWxlLCBsb2NrRmlsZSwgZG93bmxvYWRGaWxlXSwgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgcmVzLmxvY2Fscy56aXAucGlwZShyZXMpXHJcbiAgICAgICAgcmVzLmxvY2Fscy56aXAuZmluYWxpemUoKVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7cG9zdH0gL2RvY3VtZW50L2NoZWNrb3V0LzpmaWxlaWRcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50Q2hlY2tpblxyXG4gICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAgKiBAYXBpRGVzY3JpcHRpb24gQWNjZXB0cyBhbiB1cGxvYWQgZm9yIGEgbG9ja2VkIGZpbGUgYW5kIHVubG9ja3Mgc2FpZCBmaWxlXHJcbiAgICAgKiBAYXBpUGFyYW0ge1N0cmluZ30gZmlsZWlkIFRoZSBmaWxlaWQgYXMgcGFydCBvZiB0aGUgUE9TVCBVUkxcclxuICAgICAqIEBhcGlTdWNjZXNzICgyMDApIHtPYmplY3R9IFRoZSB1cGxvYWRlZCBkb2N1bWVudFxyXG4gICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBQT1NUIHRoaXMgZmlsZVxyXG4gICAgICogQGFwaUVycm9yICg1MDApIHtTdHJpbmd9IEludGVybmFsRXJyb3IgU29tZXRoaW5nIHdlbnQgd3JvbmdcclxuICAgICAqL1xyXG4gICAgLnBvc3QoW2F1dGhlbnRpY2F0ZSwgY2hlY2tTY2hlbWEoY2hlY2tvdXQgYXMgYW55KSwgZ2V0U2luZ2xlRG9jdW1lbnQsIGNoZWNrUGVybWlzc2lvblRvRmlsZSwgdXBsb2FkRmlsZUhhbmRsZXIuYXJyYXkoJ2RvY3VtZW50cycpLCB1cGxvYWRGaWxlcywgdW5sb2NrRmlsZV0sIChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgZG9jOiByZXMubG9jYWxzLmRvYyB9KVxyXG4gICAgfSlcclxuICAgIC8qKlxyXG4gICAgKiBAYXBpIHt1bmxvY2t9IC9kb2N1bWVudC9jaGVja291dC86ZmlsZWlkXHJcbiAgICAqIEBhcGlOYW1lIGRvY3VtZW50QWRtaW5VbmxvY2tcclxuICAgICogQGFwaUdyb3VwIERvY3VtZW50XHJcbiAgICAqIEBhcGlEZXNjcmlwdGlvbiBVbmxvY2tzIGEgbG9ja2VkIGRvY3VtZW50IHdpdGhvdXQgYWN0dWFsbHkgc3VibWl0dGluZyBhIG5ldyBkb2N1bWVudCBmaWxlLiBSZXF1aXJlcyB1c2VyIHRvIGJlIGFuIGFkbWluXHJcbiAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSBmaWxlaWQgVGhlIGZpbGVpZCBhcyBwYXJ0IG9mIHRoZSBQT1NUIFVSTFxyXG4gICAgKiBAYXBpU3VjY2VzcyAoMjAwKSB7T2JqZWN0fSBUaGUgdW5sb2NrZWQgZG9jdW1lbnRcclxuICAgICogQGFwaUVycm9yICg0MDEpIFBlcm1pc3Npb25FcnJvciBOb3QgYWxsb3dlZCB0byBVTkxPQ0sgdGhpcyBmaWxlXHJcbiAgICAqIEBhcGlFcnJvciAoNTAwKSB7U3RyaW5nfSBJbnRlcm5hbEVycm9yIFNvbWV0aGluZyB3ZW50IHdyb25nXHJcbiAgICAqL1xyXG4gICAgLnVubG9jayhbYXV0aGVudGljYXRlLCByZXF1aXJlQWRtaW4sIGNoZWNrU2NoZW1hKGNoZWNrb3V0KSwgZ2V0U2luZ2xlRG9jdW1lbnQsIHVubG9ja0ZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5kb2MgfSlcclxuICAgIH0pXHJcblxyXG5yb3V0ZXIucm91dGUoJy9zaGFyZS86ZmlsZWlkJylcclxuICAgIC8qKlxyXG4gICAgICogQGFwaSB7cG9zdH0gL2RvY3VtZW50L3NoYXJlLzpmaWxlaWRcclxuICAgICAqIEBhcGlOYW1lIGRvY3VtZW50U2hhcmVGaWxlXHJcbiAgICAgKiBAYXBpR3JvdXAgRG9jdW1lbnRcclxuICAgICAqIEBhcGlEZXNjcmlwdGlvbiBTaGFyZXMgZmlsZSB3aXRoIGEgbmV3IHVzZXJcclxuICAgICAqIEBhcGlQYXJhbSB7U3RyaW5nfSBmaWxlaWQgVGhlIGZpbGVpZCBhcyBwYXJ0IG9mIHRoZSBQT1NUIFVSTFxyXG4gICAgICogQGFwaVBhcmFtIHtTdHJpbmd9IHdob1RvU2hhcmUgVXNlcm5hbWUgdG8gc2hhcmUgdGhlIGZpbGUgd2l0aC4gUHJvdmlkZWQgaW4gYm9keSBvciBxdWVyeS5cclxuICAgICAqIEBhcGlTdWNjZXNzICgyMDApIHtPYmplY3R9IFRoZSB1cGRhdGVkIGRvY3VtZW50XHJcbiAgICAgKiBAYXBpRXJyb3IgKDQwMSkgUGVybWlzc2lvbkVycm9yIE5vdCBhbGxvd2VkIHRvIGVkaXQgdGhpcyBmaWxlXHJcbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkge1N0cmluZ30gSW50ZXJuYWxFcnJvciBTb21ldGhpbmcgd2VudCB3cm9uZ1xyXG4gICAgICovXHJcbiAgICAucG9zdChbYXV0aGVudGljYXRlLCBjaGVja1NjaGVtYShzaGFyZSksIGdldFNpbmdsZURvY3VtZW50LCBzaGFyZUZpbGVdLCAocmVxLCByZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7IGRvYzogcmVzLmxvY2Fscy5kb2MgfSlcclxuICAgIH0pXHJcblxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSByb3V0ZXIiXX0=